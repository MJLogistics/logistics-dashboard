<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJL ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .metric-title {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-change {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .positive {
            background: #d4edda;
            color: #155724;
        }
        
        .negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .data-table {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        canvas {
            max-height: 400px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¢ MJL ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="subtitle">ì‹¤ì‹œê°„ í•´ìš´ ì§€ìˆ˜ ë° ìš´ì„ í˜„í™©</p>
        
        <div class="status-bar">
            <div id="status" class="status loading">
                <span class="loading-spinner"></span>
                <span>ë°ì´í„° ë¡œë”© ì¤‘...</span>
            </div>
            <div id="update-time">-</div>
        </div>
        
        <div id="error-container"></div>
        
        <div class="metrics" id="metrics">
            <div class="metric-card">
                <div class="metric-title">BDI ì§€ìˆ˜</div>
                <div class="metric-value" id="bdi-value">-</div>
                <div class="metric-change" id="bdi-change">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">SCFI ì§€ìˆ˜</div>
                <div class="metric-value" id="scfi-value">-</div>
                <div class="metric-change" id="scfi-change">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">CCFI ì§€ìˆ˜</div>
                <div class="metric-value" id="ccfi-value">-</div>
                <div class="metric-change" id="ccfi-change">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">HRCI ì§€ìˆ˜</div>
                <div class="metric-value" id="hrci-value">-</div>
                <div class="metric-change" id="hrci-change">-</div>
            </div>
        </div>
        
        <div class="data-table">
            <h3>ğŸ“Š ìµœì‹  ìš´ì„ í˜„í™©</h3>
            <table id="freight-table">
                <thead>
                    <tr>
                        <th>ì¶œë°œì§€</th>
                        <th>LA</th>
                        <th>ë¡±ë¹„ì¹˜</th>
                        <th>ë¡œí…Œë¥´ë‹´</th>
                        <th>Kandla</th>
                        <th>Paradip</th>
                        <th>JNPT</th>
                    </tr>
                </thead>
                <tbody id="freight-tbody">
                    <tr><td colspan="7">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">ğŸ“ˆ ì§€ìˆ˜ ì¶”ì´</h3>
            <canvas id="indexChart"></canvas>
        </div>
    </div>

    <script>
        // ==================== ì„¤ì • ====================
        // âš ï¸ ì‹¤ì œ Apps Script URLë¡œ êµì²´í•˜ì„¸ìš”!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzMb5jrh7SpUdTaaKAMxw_ds22V9f5vdGWkunsmtOxeoKdrSqzTElqGsZ1v8EgPWMo/exec';
        
        // ì „ì—­ ë³€ìˆ˜
        let chartInstance = null;
        let currentData = null;
        
        // ==================== ë°ì´í„° ë¡œë“œ ====================
        function loadData() {
            console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            updateStatus('loading', 'ë°ì´í„° ë¡œë”© ì¤‘...');
            
            // JSONP ì½œë°± ì„¤ì •
           function loadData() {
    console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘...');
    console.log('URL:', WEB_APP_URL);
    updateStatus('loading', 'ë°ì´í„° ë¡œë”© ì¤‘...');
    
    // JSONP ì½œë°±ì„ ì „ì—­ìœ¼ë¡œ ì„¤ì •
    window.dataCallback = function(response) {
        console.log('ì‘ë‹µ ë°›ìŒ:', response);
        
        if (response.status === 'success') {
            currentData = response.data;
            updateStatus('success', 'ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            displayData(response.data);
            updateTime();
        } else {
            updateStatus('error', 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + (response.message || ''));
            showError(response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
    };
    
    // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
    const oldScript = document.getElementById('data-script');
    if (oldScript) {
        oldScript.remove();
    }
    
    // ìŠ¤í¬ë¦½íŠ¸
        
        // ==================== UI ì—…ë°ì´íŠ¸ ====================
        function displayData(data) {
            if (!data || data.length === 0) {
                showError('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ìµœì‹  ë°ì´í„° (ë§ˆì§€ë§‰ í–‰)
            const latest = data[data.length - 1];
            const previous = data.length > 1 ? data[data.length - 2] : latest;
            
            // ì§€ìˆ˜ ì—…ë°ì´íŠ¸
            updateMetric('bdi', latest[1], previous[1]);
            updateMetric('scfi', latest[2], previous[2]);
            updateMetric('ccfi', latest[3], previous[3]);
            updateMetric('hrci', latest[4], previous[4]);
            
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateFreightTable(latest);
            
            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateChart(data);
        }
        
        function updateMetric(name, current, previous) {
            const value = parseFloat(current) || 0;
            const prev = parseFloat(previous) || value;
            const change = prev !== 0 ? ((value - prev) / prev * 100).toFixed(1) : 0;
            
            document.getElementById(`${name}-value`).textContent = value.toFixed(1);
            
            const changeEl = document.getElementById(`${name}-change`);
            changeEl.textContent = `${change > 0 ? 'â–²' : 'â–¼'} ${Math.abs(change)}%`;
            changeEl.className = `metric-change ${change >= 0 ? 'positive' : 'negative'}`;
        }
        
        function updateFreightTable(rowData) {
            const tbody = document.getElementById('freight-tbody');
            const origins = ['ìƒí•´', 'í™ì½©', 'ì‹¬ì²œ', 'í•˜ë…¸ì´', 'í˜¸ì¹˜ë¯¼'];
            
            let html = '';
            for (let i = 0; i < origins.length; i++) {
                const startIdx = 5 + (i * 6);
                html += `<tr>
                    <td><strong>${origins[i]}</strong></td>
                    <td>$${parseFloat(rowData[startIdx] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 1] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 2] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 3] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 4] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 5] || 0).toFixed(0)}</td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('indexChart').getContext('2d');
            
            // ìµœê·¼ 12ê°œ ë°ì´í„°ë§Œ
            const recentData = data.slice(-12);
            const labels = recentData.map(row => {
                const date = new Date(row[0]);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'BDI',
                            data: recentData.map(row => parseFloat(row[1])),
                            borderColor: '#3498db',
                            tension: 0.4
                        },
                        {
                            label: 'SCFI',
                            data: recentData.map(row => parseFloat(row[2])),
                            borderColor: '#e74c3c',
                            tension: 0.4
                        },
                        {
                            label: 'CCFI',
                            data: recentData.map(row => parseFloat(row[3])),
                            borderColor: '#f39c12',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            
            if (type === 'loading') {
                status.innerHTML = '<span class="loading-spinner"></span><span>' + message + '</span>';
            } else {
                status.innerHTML = '<span>' + message + '</span>';
            }
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = 
                `ìµœì¢… ì—…ë°ì´íŠ¸: ${now.toLocaleString('ko-KR')}`;
        }
        
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">âš ï¸ ${message}</div>`;
        }
        
        // ==================== ì´ˆê¸°í™” ====================
        window.onload = function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            console.log('Apps Script URL:', WEB_APP_URL);
            
            if (WEB_APP_URL.includes('YOUR_ACTUAL_URL')) {
                showError('Apps Script URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!');
                updateStatus('error', 'URL ì„¤ì • í•„ìš”');
            } else {
                loadData();
                
                // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
                setInterval(loadData, 5 * 60 * 1000);
            }
        };
    </script>
</body>
</html>
