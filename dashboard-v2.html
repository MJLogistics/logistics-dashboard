<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJL 물류 운임 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .metric-title {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-change {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .positive {
            background: #d4edda;
            color: #155724;
        }
        
        .negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .data-table {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        canvas {
            max-height: 400px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚢 MJL 글로벌 물류 운임 대시보드</h1>
        <p class="subtitle">실시간 해운 지수 및 운임 현황</p>
        
        <div class="status-bar">
            <div id="status" class="status loading">
                <span class="loading-spinner"></span>
                <span>데이터 로딩 중...</span>
            </div>
            <div id="update-time">-</div>
        </div>
        
        <div id="error-container"></div>
        
        <div class="metrics" id="metrics">
            <div class="metric-card">
                <div class="metric-title">BDI 지수</div>
                <div class="metric-value" id="bdi-value">-</div>
                <div class="metric-change" id="bdi-change">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">SCFI 지수</div>
                <div class="metric-value" id="scfi-value">-</div>
                <div class="metric-change" id="scfi-change">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">CCFI 지수</div>
                <div class="metric-value" id="ccfi-value">-</div>
                <div class="metric-change" id="ccfi-change">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">HRCI 지수</div>
                <div class="metric-value" id="hrci-value">-</div>
                <div class="metric-change" id="hrci-change">-</div>
            </div>
        </div>
        
        <div class="data-table">
            <h3>📊 최신 운임 현황</h3>
            <table id="freight-table">
                <thead>
                    <tr>
                        <th>출발지</th>
                        <th>LA</th>
                        <th>롱비치</th>
                        <th>로테르담</th>
                        <th>Kandla</th>
                        <th>Paradip</th>
                        <th>JNPT</th>
                    </tr>
                </thead>
                <tbody id="freight-tbody">
                    <tr><td colspan="7">데이터 로딩 중...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">📈 지수 추이</h3>
            <canvas id="indexChart"></canvas>
        </div>
    </div>

    <script>
        // ==================== 설정 ====================
        // ⚠️ 실제 Apps Script URL로 교체하세요!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzMb5jrh7SpUdTaaKAMxw_ds22V9f5vdGWkunsmtOxeoKdrSqzTElqGsZ1v8EgPWMo/exec';
        
        // 전역 변수
        let chartInstance = null;
        let currentData = null;
        
        // ==================== 데이터 로드 ====================
        function loadData() {
            console.log('데이터 로드 시작...');
            updateStatus('loading', '데이터 로딩 중...');
            
            // JSONP 콜백 설정
           function loadData() {
    console.log('데이터 로드 시작...');
    console.log('URL:', WEB_APP_URL);
    updateStatus('loading', '데이터 로딩 중...');
    
    // JSONP 콜백을 전역으로 설정
    window.dataCallback = function(response) {
        console.log('응답 받음:', response);
        
        if (response.status === 'success') {
            currentData = response.data;
            updateStatus('success', '데이터 로드 완료');
            displayData(response.data);
            updateTime();
        } else {
            updateStatus('error', '데이터 로드 실패: ' + (response.message || ''));
            showError(response.message || '알 수 없는 오류');
        }
    };
    
    // 기존 스크립트 제거
    const oldScript = document.getElementById('data-script');
    if (oldScript) {
        oldScript.remove();
    }
    
    // 스크립트
        
        // ==================== UI 업데이트 ====================
        function displayData(data) {
            if (!data || data.length === 0) {
                showError('데이터가 비어있습니다.');
                return;
            }
            
            // 최신 데이터 (마지막 행)
            const latest = data[data.length - 1];
            const previous = data.length > 1 ? data[data.length - 2] : latest;
            
            // 지수 업데이트
            updateMetric('bdi', latest[1], previous[1]);
            updateMetric('scfi', latest[2], previous[2]);
            updateMetric('ccfi', latest[3], previous[3]);
            updateMetric('hrci', latest[4], previous[4]);
            
            // 테이블 업데이트
            updateFreightTable(latest);
            
            // 차트 업데이트
            updateChart(data);
        }
        
        function updateMetric(name, current, previous) {
            const value = parseFloat(current) || 0;
            const prev = parseFloat(previous) || value;
            const change = prev !== 0 ? ((value - prev) / prev * 100).toFixed(1) : 0;
            
            document.getElementById(`${name}-value`).textContent = value.toFixed(1);
            
            const changeEl = document.getElementById(`${name}-change`);
            changeEl.textContent = `${change > 0 ? '▲' : '▼'} ${Math.abs(change)}%`;
            changeEl.className = `metric-change ${change >= 0 ? 'positive' : 'negative'}`;
        }
        
        function updateFreightTable(rowData) {
            const tbody = document.getElementById('freight-tbody');
            const origins = ['상해', '홍콩', '심천', '하노이', '호치민'];
            
            let html = '';
            for (let i = 0; i < origins.length; i++) {
                const startIdx = 5 + (i * 6);
                html += `<tr>
                    <td><strong>${origins[i]}</strong></td>
                    <td>$${parseFloat(rowData[startIdx] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 1] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 2] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 3] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 4] || 0).toFixed(0)}</td>
                    <td>$${parseFloat(rowData[startIdx + 5] || 0).toFixed(0)}</td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }
        
        function updateChart(data) {
            const ctx = document.getElementById('indexChart').getContext('2d');
            
            // 최근 12개 데이터만
            const recentData = data.slice(-12);
            const labels = recentData.map(row => {
                const date = new Date(row[0]);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'BDI',
                            data: recentData.map(row => parseFloat(row[1])),
                            borderColor: '#3498db',
                            tension: 0.4
                        },
                        {
                            label: 'SCFI',
                            data: recentData.map(row => parseFloat(row[2])),
                            borderColor: '#e74c3c',
                            tension: 0.4
                        },
                        {
                            label: 'CCFI',
                            data: recentData.map(row => parseFloat(row[3])),
                            borderColor: '#f39c12',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            
            if (type === 'loading') {
                status.innerHTML = '<span class="loading-spinner"></span><span>' + message + '</span>';
            } else {
                status.innerHTML = '<span>' + message + '</span>';
            }
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = 
                `최종 업데이트: ${now.toLocaleString('ko-KR')}`;
        }
        
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">⚠️ ${message}</div>`;
        }
        
        // ==================== 초기화 ====================
        window.onload = function() {
            console.log('페이지 로드 완료');
            console.log('Apps Script URL:', WEB_APP_URL);
            
            if (WEB_APP_URL.includes('YOUR_ACTUAL_URL')) {
                showError('Apps Script URL을 설정해주세요!');
                updateStatus('error', 'URL 설정 필요');
            } else {
                loadData();
                
                // 5분마다 자동 새로고침
                setInterval(loadData, 5 * 60 * 1000);
            }
        };
    </script>
</body>
</html>
