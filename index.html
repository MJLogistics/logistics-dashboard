<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MJL ì•„ì‹œì•„ë°œ ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== ìŠ¤íƒ€ì¼(ìš”ì•½) â€“ ì›ë˜ ëŠë‚Œ ìœ ì§€ ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;padding:20px}
    .dashboard{max-width:1920px;margin:0 auto;background:rgba(255,255,255,.98);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #e0e0e0}
    h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;background:linear-gradient(135deg,#e74c3c,#c0392b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold}
    .subtitle{color:#7f8c8d;font-size:1.2em;margin-bottom:15px}
    .update-info{display:flex;justify-content:center;gap:20px;margin-top:10px;flex-wrap:wrap}
    .update-time{color:#7f8c8d;font-size:.9em}
    .data-status{background:#e74c3c;color:#fff;padding:3px 10px;border-radius:15px;font-size:.85em}
    .sync-status{background:#27ae60;color:#fff;padding:3px 10px;border-radius:15px;font-size:.85em;display:inline-flex;align-items:center;gap:5px}
    .sync-status.syncing{background:#f39c12}
    .sync-status.error{background:#e74c3c}
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid #fff;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .control-panel{background:linear-gradient(135deg,#ffeaa7 0%,#fdcb6e 100%);padding:20px;border-radius:15px;margin-bottom:25px}
    .time-range-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .time-btn{padding:8px 16px;border:2px solid #e74c3c;background:#fff;color:#e74c3c;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s}
    .time-btn.active{background:#e74c3c;color:#fff}
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
    .metric-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);border-top:4px solid}
    .metric-card:nth-child(1){border-top-color:#3498db}.metric-card:nth-child(2){border-top-color:#e74c3c}
    .metric-card:nth-child(3){border-top-color:#f39c12}.metric-card:nth-child(4){border-top-color:#2ecc71}
    .metric-title{font-size:.9em;color:#7f8c8d;font-weight:600;margin-bottom:10px}
    .metric-value{font-size:2.2em;font-weight:bold;color:#2c3e50;margin-bottom:10px}
    .metric-change{font-size:1em;padding:5px 10px;border-radius:12px;display:inline-block;font-weight:600}
    .positive{color:#27ae60;background:rgba(39,174,96,.1)} .negative{color:#e74c3c;background:rgba(231,76,60,.1)}
    .freight-table{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:30px}
    .freight-table table{width:100%;border-collapse:collapse;font-size:.9em}
    .freight-table th,.freight-table td{padding:10px 8px;text-align:center;border:1px solid #e0e0e0;white-space:nowrap}
    .freight-table th{background:#e74c3c;color:#fff;font-weight:600}
    .origin-header{background:#34495e!important}
    .destination-header{background:#2c3e50!important;font-size:.85em}
    .chart-container{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:30px;margin-bottom:30px}
    .chart-title{font-size:1.3em;color:#2c3e50;margin-bottom:15px;font-weight:600}
    .filters{display:flex;gap:10px;align-items:center;margin:10px 0 0 0;flex-wrap:wrap}
    @media(max-width:768px){.charts-grid{grid-template-columns:1fr} h1{font-size:1.8em}}
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <h1>ğŸš¢ âœˆï¸ MJL ì•„ì‹œì•„ë°œ ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="subtitle">MJ LOGISTICS GLOBAL FREIGHT RATE DASHBOARD</div>
      <div class="update-info">
        <span class="update-time" id="updateTime">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
        <span class="data-status">ì•„ì‹œì•„(ì¤‘êµ­/ë² íŠ¸ë‚¨) â†’ ë¶ë¯¸/ìœ ëŸ½/ì¸ë„</span>
        <span class="sync-status syncing" id="syncStatus"><span class="spinner"></span> <span id="syncText">ì—°ê²° ì¤‘...</span></span>
      </div>
    </div>

    <div class="control-panel">
      <div class="time-range-buttons">
        <button class="time-btn" data-range="2W">2ì£¼</button>
        <button class="time-btn" data-range="1M">1ê°œì›”</button>
        <button class="time-btn" data-range="3M">3ê°œì›”</button>
        <button class="time-btn" data-range="6M">6ê°œì›”</button>
        <button class="time-btn active" data-range="1Y">1ë…„</button>
        <button class="time-btn" data-range="2Y">2ë…„</button>
        <button class="time-btn" data-range="Max">ì „ì²´</button>
      </div>
      <div class="filters">
        <label>ìš´ì„ í˜„í™© ê¸°ì¤€ì¼: </label>
        <select id="dateSelect"></select>
        <small style="color:#7f8c8d">ê°€ì¥ ê°€ê¹Œìš´ ì£¼ê°„ ë°ì´í„°ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</small>
      </div>
    </div>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-title">ë°œí‹±ìš´ì„ì§€ìˆ˜ (BDI)</div>
        <div class="metric-value" id="bdiValue">-</div>
        <span class="metric-change" id="bdiChange">-</span>
      </div>
      <div class="metric-card">
        <div class="metric-title">ìƒí•´ì»¨í…Œì´ë„ˆìš´ì„ì§€ìˆ˜ (SCFI)</div>
        <div class="metric-value" id="scfiValue">-</div>
        <span class="metric-change" id="scfiChange">-</span>
      </div>
      <div class="metric-card">
        <div class="metric-title">ì¤‘êµ­ì»¨í…Œì´ë„ˆìš´ì„ì§€ìˆ˜ (CCFI)</div>
        <div class="metric-value" id="ccfiValue">-</div>
        <span class="metric-change" id="ccfiChange">-</span>
      </div>
      <div class="metric-card">
        <div class="metric-title">HRCI ì§€ìˆ˜</div>
        <div class="metric-value" id="hrciValue">-</div>
        <span class="metric-change" id="hrciChange">-</span>
      </div>
    </div>

    <div class="freight-table">
      <h3 class="chart-title">ğŸ“Š ìš´ì„ í˜„í™© <span id="asOfLabel" style="color:#e74c3c;font-size:.9em;"></span></h3>
      <table>
        <thead>
          <tr>
            <th rowspan="3" class="origin-header">ì¶œë°œì§€</th>
            <th colspan="2">ë¶ë¯¸ì„œë¶€</th>
            <th colspan="1">ìœ ëŸ½</th>
            <th colspan="3">ì¸ë„</th>
          </tr>
          <tr class="destination-header">
            <th>LA</th><th>ë¡±ë¹„ì¹˜</th><th>ë¡œí…Œë¥´ë‹´</th><th>Kandla</th><th>Paradip</th><th>JNPT</th>
          </tr>
          <tr class="destination-header">
            <th colspan="6" style="background:#7f8c8d;">ë‹¨ìœ„: USD/TEU</th>
          </tr>
        </thead>
        <tbody id="seaTableBody"></tbody>
      </table>

      <div style="height:10px"></div>

      <table>
        <thead>
          <tr>
            <th rowspan="3" class="origin-header">ì¶œë°œì§€</th>
            <th colspan="2">ë¶ë¯¸</th>
            <th colspan="1">ìœ ëŸ½</th>
            <th colspan="3">ì¸ë„</th>
          </tr>
          <tr class="destination-header">
            <th>LAX</th><th>JFK</th><th>VIE</th><th>DEL</th><th>BOM</th><th>BLR</th>
          </tr>
          <tr class="destination-header">
            <th colspan="6" style="background:#7f8c8d;">ë‹¨ìœ„: USD/kg</th>
          </tr>
        </thead>
        <tbody id="airTableBody"></tbody>
      </table>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h3 class="chart-title">ğŸ“ˆ í•´ìš´ ì§€ìˆ˜ ì¶”ì´</h3>
        <canvas id="indexChart" height="400"></canvas>
      </div>
      <div class="chart-container">
        <h3 class="chart-title">ğŸš¢ ë¶ë¯¸ í•´ìƒ ìš´ì„ ë¹„êµ (â†’ LA)</h3>
        <canvas id="usSeaChart" height="400"></canvas>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h3 class="chart-title">ğŸš¢ ìœ ëŸ½ í•´ìƒ ìš´ì„ ë¹„êµ (â†’ ë¡œí…Œë¥´ë‹´)</h3>
        <canvas id="euSeaChart" height="400"></canvas>
      </div>
      <div class="chart-container">
        <h3 class="chart-title">âœˆï¸ í•­ê³µ ìš´ì„ ë¹„êµ (â†’ LAX)</h3>
        <canvas id="airChart" height="400"></canvas>
      </div>
    </div>
  </div>

  <script>
    /* ========== ì„¤ì • ========== */
    const DEBUG = false;
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzMb5jrh7SpUdTaaKAMxw_ds22V9f5vdGWkunsmtOxeoKdrSqzTElqGsZ1v8EgPWMo/exec';
    const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5ë¶„

    /* ========== ì „ì—­ ìƒíƒœ ========== */
    let charts = {};
    let refreshTimer = null;
    let currentTimeRange = '1Y';
    let viewIdx = null; // ìš´ì„ í˜„í™©ì—ì„œ ì„ íƒëœ ê¸°ì¤€ì¼ index

    const ORIGIN_KR_TO_KEY = { 'ìƒí•´':'shanghai','í™ì½©':'hongkong','ì‹¬ì²œ':'shenzhen','í•˜ë…¸ì´':'hanoi','í˜¸ì¹˜ë¯¼':'hochiminh' };
    const SEA_DEST = { 'LA':'la','ë¡±ë¹„ì¹˜':'longbeach','ë¡œí…Œë¥´ë‹´':'rotterdam','KANDLA':'kandla','PARADIP':'paradip','JNPT':'jnpt' };
    const AIR_DEST = { 'LAX':'lax','JFK':'jfk','VIE':'vie','DEL':'del','BOM':'bom','BLR':'blr' };
    const ORIGIN_ORDER = ['shanghai','hongkong','shenzhen','hanoi','hochiminh'];
    const ORIGIN_NAME = { shanghai:'ğŸ‡¨ğŸ‡³ ìƒí•´', hongkong:'ğŸ‡­ğŸ‡° í™ì½©', shenzhen:'ğŸ‡¨ğŸ‡³ ì‹¬ì²œ', hanoi:'ğŸ‡»ğŸ‡³ í•˜ë…¸ì´', hochiminh:'ğŸ‡»ğŸ‡³ í˜¸ì¹˜ë¯¼' };

    let dataStore = emptyData();

    function emptyData(){
      const initFreight = ()=>({
        sea:{ la:[],longbeach:[],rotterdam:[],kandla:[],paradip:[],jnpt:[] },
        air:{ lax:[],jfk:[],vie:[],del:[],bom:[],blr:[] }
      });
      const freight = {};
      ORIGIN_ORDER.forEach(k=>freight[k]=initFreight());
      return {
        dates: [], datesStr: [],
        indices: { BDI:[], SCFI:[], CCFI:[], HRCI:[] },
        freight
      };
    }

    function log(){ if(DEBUG) console.log.apply(console, arguments); }

    /* ========== ìœ í‹¸ ========== */
    const norm = s => String(s ?? '').replace(/\s+/g,'').toUpperCase();
    function toNum(v){
      if(typeof v === 'number') return isFinite(v)?v:0;
      if(typeof v === 'string'){
        const t = v.trim();
        if(!t || t === '-') return 0;
        const n = Number(t.replace(/,/g,''));
        return isNaN(n)?0:n;
      }
      return 0;
    }
    function parseDateCell(v){
      if(v instanceof Date && !isNaN(v)) return v;
      if(typeof v === 'string'){
        const s = v.trim().replace(/[./]/g,'-');
        const d = new Date(s);
        if(!isNaN(d)) return d;
      }
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    function setSync(status, text){
      const el = document.getElementById('syncStatus');
      const tx = document.getElementById('syncText');
      el.className = 'sync-status';
      if(status==='syncing') el.classList.add('syncing');
      if(status==='error') el.classList.add('error');
      tx.textContent = text;
    }

    /* ========== JSONP ì½œë°±ì„ ë¨¼ì € ë“±ë¡ ========== */
    window.handleGoogleSheetsData = function(payload){
      try{
        log('[JSONP] ì½œë°± ìˆ˜ì‹ ', payload?.status, payload?.rowCount, payload?.colCount, payload?.sheet);
        if(payload && payload.status === 'success' && Array.isArray(payload.data)){
          parseSheetData(payload.data);
          afterDataReady();
          setSync('success','ë™ê¸°í™” ì™„ë£Œ');
          document.getElementById('updateTime').textContent =
            'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
        }else{
          console.warn('ë°ì´í„° ì˜¤ë¥˜:', payload);
          setSync('error','ë°ì´í„° ì˜¤ë¥˜');
          loadSampleData(true);
        }
      }catch(err){
        console.error('ì½œë°± ì²˜ë¦¬ ì‹¤íŒ¨:', err);
        setSync('error','ë°ì´í„° ì˜¤ë¥˜');
        loadSampleData(true);
      }
    };

    /* ========== JSONP ìŠ¤í¬ë¦½íŠ¸ ì‚½ì… ========== */
    function loadFromAppsScript(){
      setSync('syncing','ë°ì´í„° ë™ê¸°í™” ì¤‘...');
      const old = document.getElementById('sheets-data-script');
      if(old) old.remove();
      const s = document.createElement('script');
      s.id  = 'sheets-data-script';
      s.src = WEB_APP_URL + '?callback=handleGoogleSheetsData&_=' + Date.now(); // ìºì‹œ íšŒí”¼
      s.onerror = ()=>{ console.error('JSONP ë¡œë“œ ì‹¤íŒ¨'); setSync('error','ì—°ê²° ì‹¤íŒ¨'); loadSampleData(true); };
      document.body.appendChild(s);
    }

    /* ========== ì‹œíŠ¸ íŒŒì‹±(í—¤ë” ìë™ ë§¤í•‘) ========== */
    function parseSheetData(rows){
      if(!Array.isArray(rows) || rows.length < 2) throw new Error('sheet rows ë¶€ì¡±');

      dataStore = emptyData();

      const header = rows[0].map(h => (h ?? '').toString());
      const HN = header.map(h=>norm(h));

      // í—¤ë” ì»¬ëŸ¼ ì¸ë±ìŠ¤ íƒìƒ‰
      let colDate = HN.findIndex(h=> h.includes('ë‚ ì§œ') || h.includes('DATE'));
      if(colDate < 0) colDate = 0; // ì²« ì—´ì´ ë‚ ì§œì¼ ê°€ëŠ¥ì„±

      const colBDI  = HN.findIndex(h=> h.includes('BDI'));
      const colSCFI = HN.findIndex(h=> h.includes('SCFI'));
      const colCCFI = HN.findIndex(h=> h.includes('CCFI'));
      const colHRCI = HN.findIndex(h=> h.includes('HRCI'));

      // ëª©ì ì§€ ë§¤í•‘ìš© í•¨ìˆ˜
      const findOriginKey = (h) => {
        for(const [kr,key] of Object.entries(ORIGIN_KR_TO_KEY)){
          if(h.includes(kr)) return key;
        }
        return null;
      };
      const findSeaDest = (h) => {
        for(const [label, key] of Object.entries(SEA_DEST)){
          if(h.includes(label)) return key;
        }
        // 'LA'ëŠ” LAXì™€ ê²¹ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•´ìƒì—ì„œë§Œ ì²˜ë¦¬
        if(h.includes('LA')) return 'la';
        return null;
      };
      const findAirDest = (h) => {
        for(const [label, key] of Object.entries(AIR_DEST)){
          if(h.includes(label)) return key;
        }
        return null;
      };

      // ê° ìš´ì„ ì»¬ëŸ¼ì˜ {type, origin, dest, col} ë§¤í•‘í‘œë¥¼ êµ¬ì„±
      const colMap = [];
      header.forEach((h, idx)=>{
        if(idx === colDate || idx===colBDI || idx===colSCFI || idx===colCCFI || idx===colHRCI) return;
        const u = HN[idx];
        const isSea = u.includes('í•´ìƒ');
        const isAir = u.includes('í•­ê³µ');

        if(!isSea && !isAir) return;

        const origin = findOriginKey(h);
        if(!origin) return;

        let dest = isSea ? findSeaDest(h) : findAirDest(h);
        if(!dest) return;

        colMap.push({ type: isSea?'sea':'air', origin, dest, col: idx });
      });

      // ë°ì´í„° ì±„ìš°ê¸°
      for(let r=1; r<rows.length; r++){
        const row = rows[r];

        const d = parseDateCell(row[colDate]);
        if(!d) continue;

        dataStore.dates.push(d);
        dataStore.datesStr.push(ymd(d));

        if(colBDI  >=0) dataStore.indices.BDI .push(toNum(row[colBDI ]));
        if(colSCFI >=0) dataStore.indices.SCFI.push(toNum(row[colSCFI]));
        if(colCCFI >=0) dataStore.indices.CCFI.push(toNum(row[colCCFI]));
        if(colHRCI >=0) dataStore.indices.HRCI.push(toNum(row[colHRCI]));

        // ìš´ì„ë“¤
        colMap.forEach(m=>{
          const v = toNum(row[m.col]);
          if(m.type==='sea') dataStore.freight[m.origin].sea[m.dest].push(v);
          else               dataStore.freight[m.origin].air[m.dest].push(v);
        });
      }

      log('[parse] dates=', dataStore.dates.length, 'cols map=', colMap.length);
    }

    /* ========== ìƒ˜í”Œ ë°ì´í„° (ì‹¤íŒ¨ ì‹œ ì•ˆì „ì¥ì¹˜) ========== */
    function loadSampleData(reset){
      if(reset) dataStore = emptyData();
      const weeks = 52; const end = new Date();
      for(let i=0;i<weeks;i++){
        const d = new Date(end); d.setDate(d.getDate() - (weeks-i)*7);
        dataStore.dates.push(d); dataStore.datesStr.push(ymd(d));
        dataStore.indices.BDI .push(1100+Math.random()*200);
        dataStore.indices.SCFI.push( 900+Math.random()*200);
        dataStore.indices.CCFI.push( 950+Math.random()*100);
        dataStore.indices.HRCI.push( 600+Math.random()*100);
        ORIGIN_ORDER.forEach(o=>{
          dataStore.freight[o].sea.la        .push(1500+Math.random()*300);
          dataStore.freight[o].sea.longbeach .push(1550+Math.random()*300);
          dataStore.freight[o].sea.rotterdam .push(3400+Math.random()*400);
          dataStore.freight[o].sea.kandla    .push( 800+Math.random()*200);
          dataStore.freight[o].sea.paradip   .push( 850+Math.random()*200);
          dataStore.freight[o].sea.jnpt      .push( 900+Math.random()*200);

          dataStore.freight[o].air.lax.push(4.5+Math.random());
          dataStore.freight[o].air.jfk.push(5.0+Math.random());
          dataStore.freight[o].air.vie.push(3.8+Math.random());
          dataStore.freight[o].air.del.push(2.5+Math.random());
          dataStore.freight[o].air.bom.push(2.7+Math.random());
          dataStore.freight[o].air.blr.push(2.8+Math.random());
        });
      }
      afterDataReady();
      setSync('error','ìƒ˜í”Œ ë°ì´í„°(ì—°ê²° ì‹¤íŒ¨)');
    }

    /* ========== UI ê°±ì‹  ì—”ì§„ ========== */
    function afterDataReady(){
      // ë‚ ì§œ ì„ íƒ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
      const sel = document.getElementById('dateSelect');
      sel.innerHTML = '';
      dataStore.datesStr.forEach((ds, i)=>{
        const opt = document.createElement('option');
        opt.value = ds; opt.textContent = ds;
        sel.appendChild(opt);
      });
      // ê¸°ë³¸: ìµœì‹ ì¼ì
      viewIdx = dataStore.dates.length - 1;
      sel.value = dataStore.datesStr[viewIdx];
      sel.onchange = ()=>{
        const i = dataStore.datesStr.indexOf(sel.value);
        viewIdx = (i>=0)? i : dataStore.datesStr.length-1;
        updateMetrics(); updateTables(); // ì°¨íŠ¸ëŠ” ê¸°ê°„ í•„í„°ë¡œ ì „ì²´ ì¶”ì´ ê·¸ë¦¬ë‹ˆê¹Œ ê·¸ëŒ€ë¡œ
      };

      updateMetrics();
      updateTables();
      updateCharts();
    }

    function startIndexByRange(){
      const end = dataStore.dates.length - 1;
      if(end < 0) return 0;
      switch(currentTimeRange){
        case '2W': return Math.max(0, end-2);
        case '1M': return Math.max(0, end-4);
        case '3M': return Math.max(0, end-13);
        case '6M': return Math.max(0, end-26);
        case '1Y': return Math.max(0, end-52);
        case '2Y': return Math.max(0, end-104);
        default: return 0;
      }
    }

    function updateMetrics(){
      if(dataStore.dates.length===0) return;
      const start = startIndexByRange();
      const last  = viewIdx ?? (dataStore.dates.length-1);

      function setMetric(key, valueId, changeId, digits){
        const curr = dataStore.indices[key][last] ?? 0;
        const base = dataStore.indices[key][start] ?? curr;
        const pct  = (base===0)? null : ((curr-base)/base*100);
        document.getElementById(valueId).textContent = (isFinite(curr)?curr.toFixed(digits):'-');
        const el = document.getElementById(changeId);
        if(pct==null){ el.textContent='-'; el.className='metric-change'; }
        else{
          el.textContent = `${pct>=0?'â–²':'â–¼'} ${Math.abs(pct).toFixed(1)}%`;
          el.className   = `metric-change ${pct>=0?'positive':'negative'}`;
        }
      }

      setMetric('BDI','bdiValue','bdiChange',0);
      setMetric('SCFI','scfiValue','scfiChange',2);
      setMetric('CCFI','ccfiValue','ccfiChange',2);
      setMetric('HRCI','hrciValue','hrciChange',1);

      const d = dataStore.dates[last];
      document.getElementById('asOfLabel').textContent =
        `(${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ê¸°ì¤€)`;
    }

    function updateTables(){
      if(dataStore.dates.length===0) return;
      const i = viewIdx ?? (dataStore.dates.length-1);

      // í•´ìƒ
      const seaBody = document.getElementById('seaTableBody');
      seaBody.innerHTML = '';
      ORIGIN_ORDER.forEach(o=>{
        const s = dataStore.freight[o].sea;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:bold">${ORIGIN_NAME[o]}</td>
          <td>${val(s.la[i])}</td>
          <td>${val(s.longbeach[i])}</td>
          <td>${val(s.rotterdam[i])}</td>
          <td>${val(s.kandla[i])}</td>
          <td>${val(s.paradip[i])}</td>
          <td>${val(s.jnpt[i])}</td>`;
        seaBody.appendChild(tr);
      });

      // í•­ê³µ
      const airBody = document.getElementById('airTableBody');
      airBody.innerHTML = '';
      ORIGIN_ORDER.forEach(o=>{
        const a = dataStore.freight[o].air;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:bold">${ORIGIN_NAME[o]}</td>
          <td>${val(a.lax[i],2)}</td>
          <td>${val(a.jfk[i],2)}</td>
          <td>${val(a.vie[i],2)}</td>
          <td>${val(a.del[i],2)}</td>
          <td>${val(a.bom[i],2)}</td>
          <td>${val(a.blr[i],2)}</td>`;
        airBody.appendChild(tr);
      });

      function val(x, d=0){ return (isFinite(x)? (d? x.toFixed(d): Math.round(x)) : '-'); }
    }

    function destroyChart(key){ if(charts[key]){ charts[key].destroy(); charts[key]=null; } }

    function updateCharts(){
      if(dataStore.dates.length===0) return;
      const start = startIndexByRange();
      const labels = dataStore.dates.slice(start).map(d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);

      // í•´ìš´ ì§€ìˆ˜
      destroyChart('index');
      charts.index = new Chart(document.getElementById('indexChart').getContext('2d'),{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'BDI',  data:dataStore.indices.BDI.slice(start),  borderColor:'#3498db',tension:.35},
            {label:'SCFI', data:dataStore.indices.SCFI.slice(start), borderColor:'#e74c3c',tension:.35},
            {label:'CCFI', data:dataStore.indices.CCFI.slice(start), borderColor:'#f39c12',tension:.35},
            {label:'HRCI', data:dataStore.indices.HRCI.slice(start), borderColor:'#2ecc71',tension:.35, yAxisID:'y1'}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{position:'left'}, y1:{position:'right', grid:{drawOnChartArea:false}} }
        }
      });

      // ë¶ë¯¸ í•´ìƒ(â†’ LA)
      destroyChart('usSea');
      charts.usSea = new Chart(document.getElementById('usSeaChart').getContext('2d'),{
        type:'line',
        data:{
          labels,
          datasets: ORIGIN_ORDER.map((o,idx)=>({
            label:`${ORIGIN_NAME[o]} â†’ LA`,
            data:dataStore.freight[o].sea.la.slice(start),
            borderColor:['#3498db','#e74c3c','#9b59b6','#f39c12','#2ecc71'][idx],
            tension:.35
          }))
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{title:{display:true,text:'USD/TEU'}} } }
      });

      // ìœ ëŸ½ í•´ìƒ(â†’ ë¡œí…Œë¥´ë‹´)
      destroyChart('euSea');
      charts.euSea = new Chart(document.getElementById('euSeaChart').getContext('2d'),{
        type:'line',
        data:{
          labels,
          datasets: ORIGIN_ORDER.map((o,idx)=>({
            label:`${ORIGIN_NAME[o]} â†’ ë¡œí…Œë¥´ë‹´`,
            data:dataStore.freight[o].sea.rotterdam.slice(start),
            borderColor:['#3498db','#e74c3c','#9b59b6','#f39c12','#2ecc71'][idx],
            tension:.35
          }))
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{title:{display:true,text:'USD/TEU'}} } }
      });

      // í•­ê³µ(â†’ LAX)
      destroyChart('air');
      charts.air = new Chart(document.getElementById('airChart').getContext('2d'),{
        type:'line',
        data:{
          labels,
          datasets: ORIGIN_ORDER.map((o,idx)=>({
            label:`${ORIGIN_NAME[o]} â†’ LAX`,
            data:dataStore.freight[o].air.lax.slice(start),
            borderColor:['#3498db','#e74c3c','#9b59b6','#f39c12','#2ecc71'][idx],
            tension:.35
          }))
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{title:{display:true,text:'USD/kg'}} } }
      });
    }

    /* ========== ì´ë²¤íŠ¸ ë°”ì¸ë”© & ë¶€íŒ… ========== */
    document.addEventListener('DOMContentLoaded', ()=>{
      // ê¸°ê°„ ë²„íŠ¼
      document.querySelectorAll('.time-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentTimeRange = btn.getAttribute('data-range');
          updateMetrics(); updateCharts();
        });
      });

      loadFromAppsScript(); // ìµœì´ˆ ë¡œë“œ
      refreshTimer = setInterval(loadFromAppsScript, AUTO_REFRESH_MS);
    });

    window.addEventListener('beforeunload', ()=>{ if(refreshTimer) clearInterval(refreshTimer); });
  </script>
</body>
</html>
