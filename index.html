<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MJL ì•„ì‹œì•„ë°œ ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;padding:20px}
    .dashboard{max-width:1920px;margin:0 auto;background:rgba(255,255,255,.98);border-radius:20px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #e0e0e0}
    h1{color:#2c3e50;font-size:2.5em;margin-bottom:10px;background:linear-gradient(135deg,#e74c3c,#c0392b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:bold}
    .subtitle{color:#7f8c8d;font-size:1.2em;margin-bottom:15px}
    .update-info{display:flex;justify-content:center;gap:20px;margin-top:10px;flex-wrap:wrap}
    .update-time{color:#7f8c8d;font-size:.9em}
    .data-status{background:#e74c3c;color:#fff;padding:3px 10px;border-radius:15px;font-size:.85em}
    .sync-status{background:#27ae60;color:#fff;padding:3px 10px;border-radius:15px;font-size:.85em;display:inline-flex;align-items:center;gap:5px}
    .sync-status.syncing{background:#f39c12}
    .sync-status.error{background:#e74c3c}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .spinner{display:inline-block;width:12px;height:12px;border:2px solid #fff;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
    .control-panel{background:linear-gradient(135deg,#ffeaa7 0%,#fdcb6e 100%);padding:25px;border-radius:15px;margin-bottom:25px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .time-range-buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .time-btn{padding:8px 16px;border:2px solid #e74c3c;background:#fff;color:#e74c3c;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s}
    .time-btn.active{background:#e74c3c;color:#fff}
    .time-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .metric-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:.3s;border-top:4px solid}
    .metric-card:nth-child(1){border-top-color:#3498db}
    .metric-card:nth-child(2){border-top-color:#e74c3c}
    .metric-card:nth-child(3){border-top-color:#f39c12}
    .metric-card:nth-child(4){border-top-color:#2ecc71}
    .metric-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .metric-title{font-size:.9em;color:#7f8c8d;font-weight:600;margin-bottom:10px}
    .metric-value{font-size:2.2em;font-weight:bold;color:#2c3e50;margin-bottom:10px}
    .metric-change{font-size:1em;padding:5px 10px;border-radius:12px;display:inline-block;font-weight:600}
    .positive{color:#27ae60;background:rgba(39,174,96,.1)}
    .negative{color:#e74c3c;background:rgba(231,76,60,.1)}
    .freight-table{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:30px;overflow-x:auto}
    .freight-table table{width:100%;border-collapse:collapse;font-size:.9em}
    .freight-table th,.freight-table td{padding:10px 8px;text-align:center;border:1px solid #e0e0e0;white-space:nowrap}
    .freight-table th{background:#e74c3c;color:#fff;font-weight:600}
    .freight-table td{font-weight:500}
    .origin-header{background:#34495e!important}
    .destination-header{background:#2c3e50!important;font-size:.85em}
    .chart-container{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:30px}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:30px;margin-bottom:30px}
    .chart-title{font-size:1.3em;color:#2c3e50;margin-bottom:20px;font-weight:600}
    .chart-canvas{position:relative;height:400px;width:100%}
    .tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e0e0e0}
    .tab{padding:10px 20px;background:none;border:none;color:#7f8c8d;cursor:pointer;font-weight:600;position:relative;transition:.3s}
    .tab.active{color:#e74c3c}
    .tab.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:#e74c3c}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .origin-selector{margin-bottom:15px}
    .origin-selector select{padding:8px 12px;border:2px solid #e74c3c;border-radius:6px;font-size:.9em;background:#fff;cursor:pointer}
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:9999}
    .loading-overlay.active{display:flex}
    .loading-content{background:#fff;padding:30px;border-radius:15px;text-align:center}
    .loading-spinner{width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #e74c3c;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    .data-source-info{background:#ecf0f1;padding:15px;border-radius:10px;margin-bottom:20px;font-size:.9em;color:#34495e}
    .data-source-info a{color:#3498db;text-decoration:none}
    .data-source-info a:hover{text-decoration:underline}
    @media (max-width:768px){
      .charts-grid{grid-template-columns:1fr}
      .freight-table{font-size:.8em}
      .freight-table th,.freight-table td{padding:6px 4px}
      h1{font-size:1.8em}
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <div class="dashboard">
    <div class="header">
      <h1>ğŸš¢ âœˆï¸ MJL ì•„ì‹œì•„ë°œ ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="subtitle">MJ LOGISTICS GLOBAL FREIGHT RATE DASHBOARD</div>
      <div class="update-info">
        <span class="update-time" id="updateTime">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
        <span class="data-status">ì•„ì‹œì•„(ì¤‘êµ­/ë² íŠ¸ë‚¨) â†’ ë¶ë¯¸/ìœ ëŸ½/ì¸ë„</span>
        <span class="sync-status" id="syncStatus"><span class="spinner"></span><span id="syncText">ì—°ê²° ì¤‘...</span></span>
      </div>
    </div>

    <div class="data-source-info">
      ğŸ“Š <strong>ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™</strong><br/>
      Google Sheets(Apps Script JSONP)ë¡œ ìë™ ì—°ë™ë©ë‹ˆë‹¤.<br/>
      ë°ì´í„° ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° <a href="https://docs.google.com/spreadsheets/d/1FST2PUn1-2cxLiv6igJ_ssCKAC9gaqvVv22j83UApts/edit?usp=drive_link" target="_blank">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</a>
    </div>

    <div class="control-panel">
      <div class="time-range-buttons">
        <button class="time-btn" data-range="2W">2ì£¼</button>
        <button class="time-btn" data-range="1M">1ê°œì›”</button>
        <button class="time-btn" data-range="3M">3ê°œì›”</button>
        <button class="time-btn" data-range="6M">6ê°œì›”</button>
        <button class="time-btn active" data-range="1Y">1ë…„</button>
        <button class="time-btn" data-range="2Y">2ë…„</button>
        <button class="time-btn" data-range="Max">ì „ì²´</button>
      </div>
    </div>

    <div class="metrics-grid" id="metricsGrid">
      <div class="metric-card">
        <div class="metric-title">ë°œí‹±ìš´ì„ì§€ìˆ˜ (BDI)</div>
        <div class="metric-value" id="bdiValue">-</div>
        <span class="metric-change" id="bdiChange">-</span>
      </div>
      <div class="metric-card">
        <div class="metric-title">ìƒí•´ì»¨í…Œì´ë„ˆìš´ì„ì§€ìˆ˜ (SCFI)</div>
        <div class="metric-value" id="scfiValue">-</div>
        <span class="metric-change" id="scfiChange">-</span>
      </div>
      <div class="metric-card">
        <div class="metric-title">ì¤‘êµ­ì»¨í…Œì´ë„ˆìš´ì„ì§€ìˆ˜ (CCFI)</div>
        <div class="metric-value" id="ccfiValue">-</div>
        <span class="metric-change" id="ccfiChange">-</span>
      </div>
      <div class="metric-card">
        <div class="metric-title">HRCI ì§€ìˆ˜</div>
        <div class="metric-value" id="hrciValue">-</div>
        <span class="metric-change" id="hrciChange">-</span>
      </div>
    </div>

    <div class="freight-table">
      <h3 class="chart-title">ğŸ“Š ìš´ì„ í˜„í™© <span id="rateDate" style="color:#e74c3c;font-size:.9em;"></span></h3>

      <!-- ë‚ ì§œ ì„ íƒ -->
      <div class="date-picker" style="display:flex;gap:10px;align-items:center;margin:10px 0 14px 0;">
        <label style="font-weight:600;color:#2c3e50;">
          í‘œì‹œ ë‚ ì§œ:
          <input type="date" id="rateDateInput" style="padding:6px 10px;border:2px solid #e74c3c;border-radius:8px;">
        </label>
        <button id="dateApplyBtn" class="time-btn" style="padding:6px 12px;">ì ìš©</button>
        <button id="datePrevBtn" class="time-btn" style="padding:6px 12px;">ì´ì „</button>
        <button id="dateNextBtn" class="time-btn" style="padding:6px 12px;">ë‹¤ìŒ</button>
        <span id="dateNearestHint" style="font-size:0.85em;color:#7f8c8d;"></span>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('sea')">ğŸš¢ í•´ìƒ ìš´ì„</button>
        <button class="tab" onclick="switchTab('air')">âœˆï¸ í•­ê³µ ìš´ì„</button>
      </div>

      <div id="seaTab" class="tab-content active">
        <table>
          <thead>
            <tr>
              <th rowspan="3" class="origin-header">ì¶œë°œì§€</th>
              <th colspan="2">ë¶ë¯¸ì„œë¶€</th>
              <th colspan="1">ìœ ëŸ½</th>
              <th colspan="3">ì¸ë„</th>
            </tr>
            <tr class="destination-header">
              <th>LA</th><th>ë¡±ë¹„ì¹˜</th><th>ë¡œí…Œë¥´ë‹´</th><th>Kandla</th><th>Paradip</th><th>JNPT</th>
            </tr>
            <tr class="destination-header">
              <th colspan="6" style="font-size:.8em;background:#7f8c8d;">ë‹¨ìœ„: USD/TEU</th>
            </tr>
          </thead>
          <tbody id="seaTableBody"></tbody>
        </table>
      </div>

      <div id="airTab" class="tab-content">
        <table>
          <thead>
            <tr>
              <th rowspan="3" class="origin-header">ì¶œë°œì§€</th>
              <th colspan="2">ë¶ë¯¸</th>
              <th colspan="1">ìœ ëŸ½</th>
              <th colspan="3">ì¸ë„</th>
            </tr>
            <tr class="destination-header">
              <th>LAX</th><th>JFK</th><th>VIE</th><th>DEL</th><th>BOM</th><th>BLR</th>
            </tr>
            <tr class="destination-header">
              <th colspan="6" style="font-size:.8em;background:#7f8c8d;">ë‹¨ìœ„: USD/kg</th>
            </tr>
          </thead>
          <tbody id="airTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h3 class="chart-title">ğŸ“ˆ í•´ìš´ ì§€ìˆ˜ ì¶”ì´</h3>
        <div class="chart-canvas"><canvas id="indexChart"></canvas></div>
      </div>
      <div class="chart-container">
        <h3 class="chart-title">ğŸš¢ ë¶ë¯¸ í•´ìƒ ìš´ì„ ë¹„êµ</h3>
        <div class="origin-selector">
          <label>ì¶œë°œì§€: </label>
          <select id="usSeaOriginSelect">
            <option value="all">ì „ì²´</option>
            <option value="shanghai">ìƒí•´</option>
            <option value="hongkong">í™ì½©</option>
            <option value="shenzhen">ì‹¬ì²œ</option>
            <option value="hanoi">í•˜ë…¸ì´</option>
            <option value="hochiminh">í˜¸ì¹˜ë¯¼</option>
          </select>
        </div>
        <div class="chart-canvas"><canvas id="usSeaChart"></canvas></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h3 class="chart-title">ğŸš¢ ìœ ëŸ½ í•´ìƒ ìš´ì„ ë¹„êµ</h3>
        <div class="origin-selector">
          <label>ì¶œë°œì§€: </label>
          <select id="euSeaOriginSelect">
            <option value="all">ì „ì²´</option>
            <option value="shanghai">ìƒí•´</option>
            <option value="hongkong">í™ì½©</option>
            <option value="shenzhen">ì‹¬ì²œ</option>
            <option value="hanoi">í•˜ë…¸ì´</option>
            <option value="hochiminh">í˜¸ì¹˜ë¯¼</option>
          </select>
        </div>
        <div class="chart-canvas"><canvas id="euSeaChart"></canvas></div>
      </div>
      <div class="chart-container">
        <h3 class="chart-title">âœˆï¸ í•­ê³µ ìš´ì„ ë¹„êµ</h3>
        <div class="origin-selector">
          <label>ì¶œë°œì§€: </label>
          <select id="airOriginSelect">
            <option value="all">ì „ì²´</option>
            <option value="shanghai">ìƒí•´</option>
            <option value="hongkong">í™ì½©</option>
            <option value="shenzhen">ì‹¬ì²œ</option>
            <option value="hanoi">í•˜ë…¸ì´</option>
            <option value="hochiminh">í˜¸ì¹˜ë¯¼</option>
          </select>
        </div>
        <div class="chart-canvas"><canvas id="airChart"></canvas></div>
      </div>
    </div>
  </div>

 <script>
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbzMb5jrh7SpUdTaaKAMxw_ds22V9f5vdGWkunsmtOxeoKdrSqzTElqGsZ1v8EgPWMo/exec';

window.handleGoogleSheetsData = function (r) {
  console.log('JSONP OK', r && r.status, r && r.meta);
  const ut=document.getElementById('updateTime');
  const st=document.getElementById('syncText');
  if (ut) ut.textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
  if (st) st.textContent = (r && r.status)==='success' ? 'ë™ê¸°í™” ì™„ë£Œ' : 'ë°ì´í„° ì˜¤ë¥˜';
  window.__jsonp_done = true;
};

(function () {
  const s=document.createElement('script');
  s.id='sheets-data-script';
  s.src=WEB_APP_URL+'?callback=handleGoogleSheetsData&_='+Date.now();
  document.body.appendChild(s);

  // 6ì´ˆ ì•ˆì— ì½œë°±ì´ ì•ˆ ì˜¤ë©´ ê²½ê³  ë¡œê·¸
  setTimeout(()=>{ 
    if(!window.__jsonp_done){ 
      console.warn('JSONP ì½œë°±ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‘ë‹µ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
    }
  }, 6000);
})();
</script>


  
  <!--

  <script>
    // ===== ì„¤ì •(Apps Script) =====
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwpaQCESa74kXX9A4urQY-uLegFJRNyu1wqIIPRji3SzdsasRjETSwuBUzV_rpM2FoK/exec';
'; // 
    const REFRESH_INTERVAL = 5 * 60 * 1000;

    // ===== ìƒíƒœ =====
    let currentData = initData();
    let charts = {};
    let currentTimeRange = '1Y';
    let refreshTimer = null;
    let selectedDateIndex = null;

    function initData(){
      return {
        dates: [],
        indices: { BDI: [], SCFI: [], CCFI: [], HRCI: [] },
        freight: ['shanghai','hongkong','shenzhen','hanoi','hochiminh'].reduce((acc,o)=>{
          acc[o]={ 
            sea:{ la:[], longbeach:[], rotterdam:[], kandla:[], paradip:[], jnpt:[] },
            air:{ lax:[], jfk:[],        vie:[],      del:[],    bom:[],   blr:[] }
          }; return acc;
        },{})
      };
    }

    // ===== JSONP ì½œë°± =====
    window.handleGoogleSheetsData = function(result){
      try{
        if(result && result.status === 'success' && Array.isArray(result.data)){
          handleRowsAndRender(result.data, result.lastUpdate);
          updateSyncStatus('success','ë™ê¸°í™” ì™„ë£Œ');
        }else{
          throw new Error(result && result.message ? result.message : 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
        }
      }catch(err){
        console.error('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', err);
        updateSyncStatus('error','ë°ì´í„° ì˜¤ë¥˜');
        showLoading(false);
      }
    };

    // ===== Apps Script ë¡œë“œ(JSONP) =====
    async function loadDataFromGoogleSheets(){
      showLoading(true);
      updateSyncStatus('syncing','ë°ì´í„° ë™ê¸°í™” ì¤‘...');
      try{
        const old = document.getElementById('sheets-data-script');
        if(old) old.remove();
        const script = document.createElement('script');
        script.id = 'sheets-data-script';
        script.src = WEB_APP_URL + '?callback=handleGoogleSheetsData&_=' + Date.now();
        script.onerror = function(){
          console.error('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
          updateSyncStatus('error','ì—°ê²° ì‹¤íŒ¨');
          showLoading(false);
        };
        document.body.appendChild(script);
      }catch(err){
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
        updateSyncStatus('error','ì—°ê²° ì˜¤ë¥˜');
        showLoading(false);
      }
    }

    // ===== rows â†’ ìƒíƒœ ë°˜ì˜ & ë Œë” =====
    function handleRowsAndRender(rows, lastUpdateStr){
      parseSheetData(rows);
      if(currentData.dates.length){
        const first=currentData.dates[0], last=currentData.dates[currentData.dates.length-1];
        const input=document.getElementById('rateDateInput');
        input.min=ymd(first); input.max=ymd(last);
        if(!input.value) input.value=ymd(last);
        selectedDateIndex=null;
        document.getElementById('dateNearestHint').textContent='';
        document.getElementById('updateTime').textContent =
          'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (lastUpdateStr ? new Date(lastUpdateStr).toLocaleString('ko-KR') : last.toLocaleString('ko-KR'));
      }
      updateAllUI();
      showLoading(false);
    }

    // ===== ë°ì´í„° íŒŒì‹± =====
    function parseSheetData(data){
      const rows = data.slice(1); // í—¤ë” ì œê±°
      currentData = initData();
      const origins = ['shanghai','hongkong','shenzhen','hanoi','hochiminh'];
      rows.forEach(row=>{
        if(!row || row.length < 65) return; // ì—´ ìˆ˜ ë¶€ì¡± ìŠ¤í‚µ(í•„ìš” ì‹œ ì™„í™”)
        currentData.dates.push(new Date(row[0]));
        currentData.indices.BDI.push(parseFloat(row[1])||0);
        currentData.indices.SCFI.push(parseFloat(row[2])||0);
        currentData.indices.CCFI.push(parseFloat(row[3])||0);
        currentData.indices.HRCI.push(parseFloat(row[4])||0);
        let col = 5;
        origins.forEach(o=>{
          currentData.freight[o].sea.la.push(        parseFloat(row[col++])||0);
          currentData.freight[o].sea.longbeach.push( parseFloat(row[col++])||0);
          currentData.freight[o].sea.rotterdam.push( parseFloat(row[col++])||0);
          currentData.freight[o].sea.kandla.push(    parseFloat(row[col++])||0);
          currentData.freight[o].sea.paradip.push(   parseFloat(row[col++])||0);
          currentData.freight[o].sea.jnpt.push(      parseFloat(row[col++])||0);
        });
        origins.forEach(o=>{
          currentData.freight[o].air.lax.push(parseFloat(row[col++])||0);
          currentData.freight[o].air.jfk.push(parseFloat(row[col++])||0);
          currentData.freight[o].air.vie.push(parseFloat(row[col++])||0);
          currentData.freight[o].air.del.push(parseFloat(row[col++])||0);
          currentData.freight[o].air.bom.push(parseFloat(row[col++])||0);
          currentData.freight[o].air.blr.push(parseFloat(row[col++])||0);
        });
      });
    }

    // ===== UI =====
    function updateAllUI(){ updateMetrics(); updateFreightTables(); updateCharts(); }
    function safePctChange(curr, start){ if(!isFinite(curr)||!isFinite(start)||start===0) return null; return ((curr-start)/start*100); }

    function updateMetrics(){
      if(!currentData.dates.length) return;
      const last = (selectedDateIndex==null) ? currentData.dates.length-1 : selectedDateIndex;
      const startIdx = Math.max(0, getStartIndex(currentTimeRange));
      const sets = [
        {key:'BDI',val:'bdiValue',chg:'bdiChange',digits:0},
        {key:'SCFI',val:'scfiValue',chg:'scfiChange',digits:2},
        {key:'CCFI',val:'ccfiValue',chg:'ccfiChange',digits:2},
        {key:'HRCI',val:'hrciValue',chg:'hrciChange',digits:1},
      ];
      sets.forEach(s=>{
        const curr = currentData.indices[s.key][currentData.dates.length-1] ?? 0; // ì§€í‘œëŠ” ìµœì‹  ê¸°ì¤€
        const start= currentData.indices[s.key][startIdx] ?? 0;
        const elVal=document.getElementById(s.val), elChg=document.getElementById(s.chg);
        elVal.textContent = isFinite(curr) ? curr.toFixed(s.digits) : '-';
        const pct = safePctChange(curr,start);
        if(pct===null){ elChg.textContent='-'; elChg.className='metric-change'; }
        else{ const sign=pct>0?'â–²':'â–¼'; elChg.textContent=`${sign} ${Math.abs(pct).toFixed(1)}%`; elChg.className=`metric-change ${pct>0?'positive':'negative'}`; }
      });
      const lastDate = currentData.dates[last];
      document.getElementById('rateDate').textContent =
        `(${lastDate.getFullYear()}ë…„ ${lastDate.getMonth()+1}ì›” ${lastDate.getDate()}ì¼ ê¸°ì¤€)`;
    }

    function updateFreightTables(){
      if(!currentData.dates.length) return;
      const last = (selectedDateIndex==null) ? currentData.dates.length-1 : selectedDateIndex;
      const origins=['shanghai','hongkong','shenzhen','hanoi','hochiminh'];
      const names=['ğŸ‡¨ğŸ‡³ ìƒí•´','ğŸ‡­ğŸ‡° í™ì½©','ğŸ‡¨ğŸ‡³ ì‹¬ì²œ','ğŸ‡»ğŸ‡³ í•˜ë…¸ì´','ğŸ‡»ğŸ‡³ í˜¸ì¹˜ë¯¼'];
      // SEA
      const seaBody=document.getElementById('seaTableBody'); seaBody.innerHTML='';
      origins.forEach((o,i)=>{
        const s=currentData.freight[o].sea;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="font-weight:bold;">${names[i]}</td>
          <td>$${(s.la[last]||0).toFixed(0)}</td>
          <td>$${(s.longbeach[last]||0).toFixed(0)}</td>
          <td>$${(s.rotterdam[last]||0).toFixed(0)}</td>
          <td>$${(s.kandla[last]||0).toFixed(0)}</td>
          <td>$${(s.paradip[last]||0).toFixed(0)}</td>
          <td>$${(s.jnpt[last]||0).toFixed(0)}</td>`;
        seaBody.appendChild(tr);
      });
      // AIR
      const airBody=document.getElementById('airTableBody'); airBody.innerHTML='';
      origins.forEach((o,i)=>{
        const a=currentData.freight[o].air;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td style="font-weight:bold;">${names[i]}</td>
          <td>$${(a.lax[last]||0).toFixed(2)}</td>
          <td>$${(a.jfk[last]||0).toFixed(2)}</td>
          <td>$${(a.vie[last]||0).toFixed(2)}</td>
          <td>$${(a.del[last]||0).toFixed(2)}</td>
          <td>$${(a.bom[last]||0).toFixed(2)}</td>
          <td>$${(a.blr[last]||0).toFixed(2)}</td>`;
        airBody.appendChild(tr);
      });
    }

    // ===== ì°¨íŠ¸ =====
    function updateCharts(){ updateIndexChart(); updateUSSeaChart(); updateEUSeaChart(); updateAirChart(); }
    function monthLabels(fromIdx){ return currentData.dates.slice(fromIdx).map(d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); }
    function destroyIfExists(key){ if(charts[key]){ charts[key].destroy(); charts[key]=null; } }

    function updateIndexChart(){
      const el=document.getElementById('indexChart'); if(!el) return;
      const ctx=el.getContext('2d'); destroyIfExists('index');
      const start=getStartIndex(currentTimeRange);
      charts.index=new Chart(ctx,{type:'line',
        data:{labels:monthLabels(start),
          datasets:[
            {label:'BDI', data:currentData.indices.BDI.slice(start), borderColor:'#3498db',tension:.4},
            {label:'SCFI',data:currentData.indices.SCFI.slice(start),borderColor:'#e74c3c',tension:.4},
            {label:'CCFI',data:currentData.indices.CCFI.slice(start),borderColor:'#f39c12',tension:.4},
            {label:'HRCI',data:currentData.indices.HRCI.slice(start),borderColor:'#2ecc71',tension:.4,yAxisID:'y1'}
          ]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},
          scales:{y:{type:'linear',display:true,position:'left'},
                  y1:{type:'linear',display:true,position:'right',grid:{drawOnChartArea:false}}}}
      });
    }

    function buildLineChart(canvasId,key,selectId,unitText){
      const el=document.getElementById(canvasId); if(!el) return;
      const ctx=el.getContext('2d'); destroyIfExists(key);
      const start=getStartIndex(currentTimeRange);
      const selected=document.getElementById(selectId).value;
      const origins=(selected==='all')?['shanghai','hongkong','shenzhen','hanoi','hochiminh']:[selected];
      const colors={shanghai:'#3498db',hongkong:'#e74c3c',shenzhen:'#9b59b6',hanoi:'#f39c12',hochiminh:'#2ecc71'};
      const names ={shanghai:'ìƒí•´',hongkong:'í™ì½©',shenzhen:'ì‹¬ì²œ',hanoi:'í•˜ë…¸ì´',hochiminh:'í˜¸ì¹˜ë¯¼'};
      const datasets=origins.map(o=>({
        label:`${names[o]} â†’ ${unitText.includes('TEU')?(key==='usSea'?'LA':'ë¡œí…Œë¥´ë‹´'):'LAX'}`,
        data:(key==='air'?currentData.freight[o].air.lax:(key==='usSea'?currentData.freight[o].sea.la:currentData.freight[o].sea.rotterdam)).slice(start),
        borderColor:colors[o],tension:.4
      }));
      charts[key]=new Chart(ctx,{type:'line',data:{labels:monthLabels(start),datasets},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:unitText}}}}});
    }
    function updateUSSeaChart(){ buildLineChart('usSeaChart','usSea','usSeaOriginSelect','USD/TEU'); }
    function updateEUSeaChart(){ buildLineChart('euSeaChart','euSea','euSeaOriginSelect','USD/TEU'); }
    function updateAirChart(){   buildLineChart('airChart','air','airOriginSelect','USD/kg'); }

    // ===== ìœ í‹¸ & ì´ë²¤íŠ¸ =====
    function getStartIndex(range){
      const end=currentData.dates.length-1; if(end<0) return 0;
      switch(range){
        case '2W': return Math.max(0, end-2);
        case '1M': return Math.max(0, end-4);
        case '3M': return Math.max(0, end-13);
        case '6M': return Math.max(0, end-26);
        case '1Y': return Math.max(0, end-52);
        case '2Y': return Math.max(0, end-104);
        default: return 0;
      }
    }
    function switchTab(name){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      if(name==='sea'){ document.querySelectorAll('.tab')[0].classList.add('active'); document.getElementById('seaTab').classList.add('active'); }
      else{ document.querySelectorAll('.tab')[1].classList.add('active'); document.getElementById('airTab').classList.add('active'); }
    }
    function ymd(d){ const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }
    function showLoading(show){ document.getElementById('loadingOverlay').classList.toggle('active', !!show); }
    function updateSyncStatus(status,text){
      const el=document.getElementById('syncStatus');
      el.className='sync-status' + (status==='syncing'?' syncing':status==='error'?' error':'');
      el.innerHTML=(status==='syncing')?`<span class="spinner"></span><span id="syncText">${text}</span>`:`<span id="syncText">${text}</span>`;
    }

    // ë‚ ì§œ ì»¨íŠ¸ë¡¤
    function applySelectedDateFromInput(){
      const inputVal=document.getElementById('rateDateInput').value;
      if(!inputVal){ selectedDateIndex=null; updateFreightTables(); updateMetrics(); return; }
      const idx=findClosestIndex(new Date(inputVal)); if(idx===null) return;
      selectedDateIndex=idx;
      const actual=currentData.dates[idx];
      document.getElementById('dateNearestHint').textContent=`ê°€ì¥ ê°€ê¹Œìš´ ë°ì´í„°: ${ymd(actual)}`;
      updateFreightTables(); updateMetrics();
    }
    function findClosestIndex(targetDate){
      if(!currentData.dates.length) return null;
      const t=new Date(targetDate).getTime();
      let best=0, diff=Math.abs(currentData.dates[0].getTime()-t);
      for(let i=1;i<currentData.dates.length;i++){
        const d=Math.abs(currentData.dates[i].getTime()-t);
        if(d<diff){ best=i; diff=d; }
      }
      return best;
    }
    function stepSelectedDate(dir){
      if(!currentData.dates.length) return;
      if(selectedDateIndex==null) selectedDateIndex=currentData.dates.length-1;
      selectedDateIndex=Math.min(currentData.dates.length-1, Math.max(0, selectedDateIndex+dir));
      const d=currentData.dates[selectedDateIndex];
      document.getElementById('rateDateInput').value=ymd(d);
      document.getElementById('dateNearestHint').textContent='';
      updateFreightTables(); updateMetrics();
    }

    // ë¶€íŒ…
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.time-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          document.querySelectorAll('.time-btn').forEach(b=>b.classList.remove('active'));
          this.classList.add('active'); currentTimeRange=this.getAttribute('data-range');
          updateMetrics(); updateCharts();
        });
      });
      ['usSeaOriginSelect','euSeaOriginSelect','airOriginSelect'].forEach(id=>{
        document.getElementById(id).addEventListener('change', ()=>({
          usSeaOriginSelect:updateUSSeaChart, euSeaOriginSelect:updateEUSeaChart, airOriginSelect:updateAirChart
        }[id]()) );
      });
      document.getElementById('dateApplyBtn').addEventListener('click', applySelectedDateFromInput);
      document.getElementById('datePrevBtn').addEventListener('click', ()=>stepSelectedDate(-1));
      document.getElementById('dateNextBtn').addEventListener('click', ()=>stepSelectedDate(1));

      loadDataFromGoogleSheets();
      refreshTimer = setInterval(loadDataFromGoogleSheets, REFRESH_INTERVAL);
    });
    document.addEventListener('visibilitychange', ()=>{
      if(refreshTimer && document.hidden){ clearInterval(refreshTimer); refreshTimer=null; }
      else if(!document.hidden){
        loadDataFromGoogleSheets();
        refreshTimer = setInterval(loadDataFromGoogleSheets, REFRESH_INTERVAL);
      }
    });
    window.addEventListener('beforeunload', ()=>{ if(refreshTimer) clearInterval(refreshTimer); });
  </script>
  
</body>
</html>
