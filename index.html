<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MJL ì•„ì‹œì•„ë°œ ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</title>
<style>
  /* ====== ê°€ë²¼ìš´ ìŠ¤íƒ€ì¼ (CSS ì˜ì¡´ ì´ìŠˆ ìµœì†Œí™”) ====== */
  :root{
    --primary:#e74c3c; --bg:#1e3c72; --bg2:#2a5298; --card:#fff;
    --muted:#7f8c8d; --text:#2c3e50; --ok:#27ae60; --warn:#f39c12;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 100%);min-height:100vh;padding:20px;color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.98);border-radius:18px;box-shadow:0 16px 48px rgba(0,0,0,.3);padding:26px}
  h1{font-size:28px;line-height:1.3;margin-bottom:8px;background:linear-gradient(135deg,#e74c3c,#c0392b);
     -webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800}
  .subtitle{color:var(--muted);margin-bottom:12px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:5px 12px;border-radius:999px;font-size:13px;color:#fff;background:var(--primary)}
  .pill.muted{background:#95a5a6}
  .pill.ok{background:var(--ok)}
  .card{background:var(--card);border-radius:14px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:18px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 6}
  .col-4{grid-column:span 4}
  .col-3{grid-column:span 3}
  .header{border-bottom:2px solid #eaeaea;padding-bottom:16px;margin-bottom:16px}
  .buttons{display:flex;gap:8px;flex-wrap:wrap}
  button.btn{padding:8px 14px;border:2px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer;font-weight:700}
  button.btn.active{background:var(--primary);color:#fff}
  .metric{display:flex;flex-direction:column;gap:6px}
  .metric .title{font-size:13px;color:var(--muted);font-weight:700}
  .metric .value{font-size:32px;font-weight:800}
  .metric .delta{display:inline-block;font-weight:700;padding:4px 10px;border-radius:999px}
  .delta.up{color:var(--ok);background:rgba(39,174,96,.12)}
  .delta.down{color:var(--primary);background:rgba(231,76,60,.12)}
  .label{color:var(--muted);font-size:13px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  input[type="date"]{padding:8px 10px;border:2px solid var(--primary);border-radius:8px;font-weight:700}
  a.link{color:#3498db;text-decoration:none}
  a.link:hover{text-decoration:underline}
  .loading{display:none;align-items:center;gap:8px}
  .loading.show{display:inline-flex}
  .spinner{width:12px;height:12px;border:2px solid #fff;border-top:2px solid transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:900px){.col-6{grid-column:span 12}.col-4{grid-column:span 12}.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>ğŸš¢ âœˆï¸ MJL ì•„ì‹œì•„ë°œ ê¸€ë¡œë²Œ ë¬¼ë¥˜ ìš´ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="subtitle">MJ LOGISTICS GLOBAL FREIGHT RATE DASHBOARD</div>
      <div class="bar">
        <span id="lastUpdate" class="pill muted">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
        <span class="pill">ì•„ì‹œì•„(ì¤‘êµ­/ë² íŠ¸ë‚¨) â†’ ë¶ë¯¸/ìœ ëŸ½/ì¸ë„</span>
        <span id="syncPill" class="pill ok">ì—°ê²° ì¤‘â€¦</span>
        <span id="debugPill" class="pill muted small">ë””ë²„ê·¸: ëŒ€ê¸°</span>
      </div>
    </div>

    <!-- ë°ì´í„° ì•ˆë‚´ -->
    <div class="card col-12" style="margin-bottom:16px">
      <div class="label">ğŸ“Š ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™</div>
      <div class="small muted" style="margin-top:4px">
        Google Sheets(Apps Script JSONP)ë¡œ ìë™ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤. ì‹œíŠ¸ ìˆ˜ì •ì€
        <a id="sheetLink" class="link" target="_blank" rel="noopener">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</a>
      </div>
    </div>

    <!-- ì»¨íŠ¸ë¡¤ -->
    <div class="card" style="margin-bottom:16px">
      <div class="row">
        <div class="col-6">
          <div class="buttons" id="rangeBtns">
            <button class="btn" data-range="2W">2ì£¼</button>
            <button class="btn" data-range="1M">1ê°œì›”</button>
            <button class="btn" data-range="3M">3ê°œì›”</button>
            <button class="btn" data-range="6M">6ê°œì›”</button>
            <button class="btn active" data-range="1Y">1ë…„</button>
            <button class="btn" data-range="2Y">2ë…„</button>
            <button class="btn" data-range="MAX">ì „ì²´</button>
          </div>
        </div>
        <div class="col-6" style="display:flex;justify-content:flex-end;gap:10px;align-items:center">
          <span class="label">ìš´ì„ í˜„í™© ê¸°ì¤€ì¼:</span>
          <input id="datePicker" type="date" />
          <span id="hintNear" class="small muted">ê°€ì¥ ê°€ê¹Œìš´ ì£¼ê°„ ë°ì´í„°ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</span>
        </div>
      </div>
    </div>

    <!-- 4 ì§€í‘œ -->
    <div class="row" id="kpiRow" style="margin-bottom:16px">
      <div class="col-4">
        <div class="card metric">
          <div class="title">ë°œí‹±ìš´ì„ì§€ìˆ˜ (BDI)</div>
          <div id="bdiVal" class="value">-</div>
          <div id="bdiDelta" class="delta">-</div>
        </div>
      </div>
      <div class="col-4">
        <div class="card metric">
          <div class="title">ìƒí•´ì»¨í…Œì´ë„ˆìš´ì„ì§€ìˆ˜ (SCFI)</div>
          <div id="scfiVal" class="value">-</div>
          <div id="scfiDelta" class="delta">-</div>
        </div>
      </div>
      <div class="col-4">
        <div class="card metric">
          <div class="title">ì¤‘êµ­ì»¨í…Œì´ë„ˆìš´ì„ì§€ìˆ˜ (CCFI)</div>
          <div id="ccfiVal" class="value">-</div>
          <div id="ccfiDelta" class="delta">-</div>
        </div>
      </div>
      <div class="col-4">
        <div class="card metric">
          <div class="title">HRCI ì§€ìˆ˜</div>
          <div id="hrciVal" class="value">-</div>
          <div id="hrciDelta" class="delta">-</div>
        </div>
      </div>
    </div>

    <!-- í…Œì´ë¸”(í•´ìƒ/í•­ê³µ) : ì»¬ëŸ¼ì´ ì¶©ë¶„ì¹˜ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ìˆ¨ê¹€ -->
    <div class="row">
      <div class="col-6">
        <div class="card">
          <div class="label" style="margin-bottom:8px">ğŸš¢ ìµœì‹  í•´ìƒ ìš´ì„ (USD/TEU)</div>
          <div id="seaTableWrap" class="small muted">ì‹œíŠ¸ì— í•´ìƒ ëª©ì ì§€ ì—´ì´ ì¤€ë¹„ë˜ë©´ ìë™ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div class="col-6">
        <div class="card">
          <div class="label" style="margin-bottom:8px">âœˆï¸ ìµœì‹  í•­ê³µ ìš´ì„ (USD/kg)</div>
          <div id="airTableWrap" class="small muted">ì‹œíŠ¸ì— í•­ê³µ ëª©ì ì§€ ì—´ì´ ì¤€ë¹„ë˜ë©´ ìë™ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===================== ì„¤ì • ===================== */
/** 1) ì—¬ê¸°ì— "í˜„ì¬" Apps Script ì›¹ì•± URL(â€¦/exec)ì„ ë¶™ì—¬ ë„£ìœ¼ì„¸ìš”. */
const WEB_APP_URL = 'PASTE_YOUR_EXEC_URL_HERE'; // â† â† â† ì—¬ê¸° ë°”ê¾¸ê¸°!

/** 2) ì‹œíŠ¸ ë³´ê¸° ë§í¬(ì„ íƒ). */
const SHEET_URL   = 'https://docs.google.com/spreadsheets/d/1FST2PUn1-2cxLiv6igJ_ssCKAC9gaqvVv22j83UApts/edit';

/** 3) ìƒˆë¡œê³ ì¹¨ ì£¼ê¸°(ë¶„). */
const REFRESH_INTERVAL_MIN = 5;

/* =============== ë‚´ë¶€ ìƒíƒœ =============== */
let rawRows = [];          // [ [í—¤ë”â€¦], [ë°ì´í„°â€¦], â€¦ ]
let header  = [];          // í—¤ë” 1í–‰
let dateCol = 0;           // ë‚ ì§œ ì—´ ì¸ë±ìŠ¤
let idxMap  = {};          // { BDI:1, SCFI:2, â€¦ }  (ì¡´ì¬í•  ë•Œë§Œ)
let lastDateIdx = -1;
let currentRange = '1Y';

/* =============== ìœ í‹¸ =============== */
const $ = sel => document.querySelector(sel);
const el = id => document.getElementById(id);
function fmt(n, d=2){ return (isFinite(n)? Number(n).toFixed(d): '-'); }
function pct(a,b){
  if(!isFinite(a)||!isFinite(b)||b===0) return null;
  return ((a-b)/b*100);
}
function nearestIndexByDate(isoDate){
  if(!rawRows.length) return -1;
  const target = new Date(isoDate).getTime();
  let best = -1, bestDiff = 1e18;
  for(let i=1;i<rawRows.length;i++){
    const t = new Date(rawRows[i][dateCol]).getTime();
    const diff = Math.abs(t-target);
    if(diff < bestDiff){ bestDiff = diff; best = i; }
  }
  return best;
}
function monthsBackIndex(months){
  if(lastDateIdx<0) return 1;
  // ë°ì´í„°ê°€ ì£¼ê°„ ê¸°ì¤€ì´ë¯€ë¡œ ëŒ€ëµ 4ì£¼ = 1ë‹¬ ê°€ì •
  const back = Math.round(months*4);
  return Math.max(1, lastDateIdx - back);
}

/* =============== UI =============== */
function setSync(text, ok=true){
  const pill = el('syncPill');
  pill.textContent = text;
  pill.className = 'pill ' + (ok ? 'ok' : 'muted');
}
function setDebug(text){ el('debugPill').textContent = 'ë””ë²„ê·¸: ' + text; }

function buildMiniTable(wrapperId, colsWanted){
  const wrap = el(wrapperId);
  // ì¤€ë¹„ëœ ëª©ì ì§€ ì—´ë§Œ ì¶”ì¶œ
  const exists = colsWanted.filter(c => header.includes(c));
  if(exists.length === 0){
    wrap.innerHTML = '<div class="small muted">ê´€ë ¨ ì—´ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  const idxs = exists.map(n => header.indexOf(n));
  const i = lastDateIdx;
  const rows = exists.map((name, k) => {
    const v = parseFloat(rawRows[i][idxs[k]])||0;
    return `<div class="row" style="align-items:center;margin-bottom:6px">
              <div class="col-6 small">${name.replaceAll('_',' ')}</div>
              <div class="col-6" style="text-align:right;font-weight:800">$${fmt(v, name.includes('kg')?2:0)}</div>
            </div>`;
  }).join('');
  wrap.innerHTML = rows;
}

/* 4 KPI ì—…ë°ì´íŠ¸ (ìˆì„ ë•Œë§Œ) */
function updateKPIs(){
  if(lastDateIdx<1) return;
  const startIdx =
    currentRange==='2W'? Math.max(1,lastDateIdx-2):
    currentRange==='1M'? Math.max(1,lastDateIdx-4):
    currentRange==='3M'? Math.max(1,lastDateIdx-13):
    currentRange==='6M'? Math.max(1,lastDateIdx-26):
    currentRange==='1Y'? Math.max(1,lastDateIdx-52):
    currentRange==='2Y'? Math.max(1,lastDateIdx-104): 1;

  const sets = [
    {k:'BDI',  val:'bdiVal',  d:'bdiDelta',  digits:0},
    {k:'SCFI', val:'scfiVal', d:'scfiDelta', digits:2},
    {k:'CCFI', val:'ccfiVal', d:'ccfiDelta', digits:2},
    {k:'HRCI', val:'hrciVal', d:'hrciDelta', digits:1},
  ];
  sets.forEach(s=>{
    const cIdx = idxMap[s.k];
    const vEl  = el(s.val), dEl = el(s.d);
    if(cIdx==null){ vEl.textContent='-'; dEl.textContent='-'; dEl.className='delta'; return; }
    const curr = parseFloat(rawRows[lastDateIdx][cIdx])||0;
    const prev = parseFloat(rawRows[startIdx][cIdx])||0;
    vEl.textContent = isFinite(curr)? fmt(curr, s.digits): '-';
    const p = pct(curr,prev);
    if(p==null){ dEl.textContent='-'; dEl.className='delta'; }
    else{
      const up = p>=0;
      dEl.textContent = (up?'â–² ':'â–¼ ') + Math.abs(p).toFixed(1)+'%';
      dEl.className = 'delta ' + (up?'up':'down');
    }
  });

  // ê¸°ì¤€ì¼
  const d = new Date(rawRows[lastDateIdx][dateCol]);
  el('lastUpdate').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* =============== ë°ì´í„° íŒŒì‹± =============== */
function parseData(arr){
  rawRows = Array.isArray(arr)? arr.slice(): [];
  if(rawRows.length<2){ throw new Error('ë°ì´í„° ë¶€ì¡±'); }
  header = rawRows[0];

  // ë‚ ì§œ ì—´ íƒì§€: 'ë‚ ì§œ' í˜¹ì€ Dateë¡œ íŒŒì‹± ê°€ëŠ¥í•œ ì²« ì—´
  dateCol = 0;
  const dateIdxByName = header.findIndex(h => (h+'').includes('ë‚ ì§œ'));
  if(dateIdxByName>=0) dateCol = dateIdxByName;

  // ì§€í‘œ ì¸ë±ìŠ¤(ìˆì„ ë•Œë§Œ ë“±ë¡)
  idxMap = {};
  ['BDI','SCFI','CCFI','HRCI'].forEach(name=>{
    const i = header.findIndex(h => (h+'').trim().toUpperCase().includes(name));
    if(i>=0) idxMap[name]=i;
  });

  // ë§ˆì§€ë§‰ í–‰(ìµœì‹ ì¼)
  lastDateIdx = rawRows.length-1;

  // datePicker: min/max ì§€ì •
  const minD = new Date(rawRows[1][dateCol]);
  const maxD = new Date(rawRows[lastDateIdx][dateCol]);
  const dp = el('datePicker');
  dp.min = minD.toISOString().slice(0,10);
  dp.max = maxD.toISOString().slice(0,10);
  dp.value = maxD.toISOString().slice(0,10);
}

/* =============== ë Œë”ë§ =============== */
function renderAll(){
  updateKPIs();

  // í•´ìƒ/í•­ê³µ ë¯¸ë‹ˆ í…Œì´ë¸”(ì—´ì´ ìˆì„ ë•Œë§Œ)
  buildMiniTable('seaTableWrap', [
    // ì‹œíŠ¸ í—¤ë” ëª…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì˜ˆ: ìƒí•´_í•´ìƒ_LA, ìƒí•´_í•´ìƒ_ë¡œí…Œë¥´ë‹´ â€¦)
    'ìƒí•´_í•´ìƒ_LA', 'ìƒí•´_í•´ìƒ_ë¡±ë¹„ì¹˜', 'ìƒí•´_í•´ìƒ_ë¡œí…Œë¥´ë‹´',
    'í™ì½©_í•´ìƒ_LA',  'í™ì½©_í•´ìƒ_ë¡±ë¹„ì¹˜',  'í™ì½©_í•´ìƒ_ë¡œí…Œë¥´ë‹´',
    'ì‹¬ì²œ_í•´ìƒ_LA',  'ì‹¬ì²œ_í•´ìƒ_ë¡±ë¹„ì¹˜',  'ì‹¬ì²œ_í•´ìƒ_ë¡œí…Œë¥´ë‹´',
  ]);
  buildMiniTable('airTableWrap', [
    // ì˜ˆì‹œ(í•„ìš” ì‹œ ì‹œíŠ¸ í—¤ë”ëª…ì— ë§ì¶° ì¶”ê°€/ìˆ˜ì •)
    'ìƒí•´_í•­ê³µ_LAX', 'ìƒí•´_í•­ê³µ_JFK', 'ìƒí•´_í•­ê³µ_VIE',
    'í™ì½©_í•­ê³µ_LAX', 'í™ì½©_í•­ê³µ_JFK', 'í™ì½©_í•­ê³µ_VIE',
  ]);
}

/* =============== JSONP ë¡œë“œ =============== */
function loadFromAppsScript(){
  setSync('ì—°ê²° ì¤‘â€¦', true); setDebug('ìš”ì²­ ì¤€ë¹„');
  // ì´ì „ ìŠ¤í¬ë¦½íŠ¸ ì œê±°
  const old = document.getElementById('jsonp-script');
  if(old) old.remove();

  // JSONP ì½œë°±
  window.handleGoogleSheetsData = function(resp){
    try{
      if(!resp || resp.status!=='success' || !Array.isArray(resp.data)){
        throw new Error('ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
      }
      setDebug('ì‘ë‹µ ìˆ˜ì‹ ');
      parseData(resp.data);
      renderAll();
      setSync('ë™ê¸°í™” ì™„ë£Œ', true);
    }catch(e){
      console.error(e);
      setSync('ë°ì´í„° ì˜¤ë¥˜', false);
      setDebug('íŒŒì‹± ì‹¤íŒ¨');
    }
  };

  // JSONP ìŠ¤í¬ë¦½íŠ¸ ì‚½ì…
  const s = document.createElement('script');
  s.id = 'jsonp-script';
  s.src = WEB_APP_URL + '?callback=handleGoogleSheetsData&_=' + Date.now();
  s.onerror = function(){
    setSync('ì—°ê²° ì‹¤íŒ¨', false);
    setDebug('JSONP ë¡œë“œ ì‹¤íŒ¨');
  };
  document.body.appendChild(s);
}

/* =============== ì´ë²¤íŠ¸ =============== */
function onRangeClick(e){
  const btn = e.target.closest('button');
  if(!btn) return;
  document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentRange = btn.dataset.range;
  renderAll();
}
function onDatePicked(e){
  const v = e.target.value;
  const i = nearestIndexByDate(v);
  if(i>0){ lastDateIdx = i; renderAll(); }
}

/* =============== ì‹œì‘ =============== */
document.addEventListener('DOMContentLoaded', ()=>{
  // ë§í¬/ì»¨íŠ¸ë¡¤
  el('sheetLink').href = SHEET_URL;
  $('#rangeBtns').addEventListener('click', onRangeClick);
  el('datePicker').addEventListener('change', onDatePicked);

  // ì²« ë¡œë“œ & ì£¼ê¸°ì  ìƒˆë¡œê³ ì¹¨
  loadFromAppsScript();
  setInterval(loadFromAppsScript, REFRESH_INTERVAL_MIN*60*1000);
});
</script>
</body>
</html>
