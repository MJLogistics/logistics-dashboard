<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MJL 아시아발 글로벌 물류 운임 대시보드</title>
<style>
  /* ====== 가벼운 스타일 (CSS 의존 이슈 최소화) ====== */
  :root{
    --primary:#e74c3c; --bg:#1e3c72; --bg2:#2a5298; --card:#fff;
    --muted:#7f8c8d; --text:#2c3e50; --ok:#27ae60; --warn:#f39c12;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 100%);min-height:100vh;padding:20px;color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.98);border-radius:18px;box-shadow:0 16px 48px rgba(0,0,0,.3);padding:26px}
  h1{font-size:28px;line-height:1.3;margin-bottom:8px;background:linear-gradient(135deg,#e74c3c,#c0392b);
     -webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800}
  .subtitle{color:var(--muted);margin-bottom:12px}
  .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:5px 12px;border-radius:999px;font-size:13px;color:#fff;background:var(--primary)}
  .pill.muted{background:#95a5a6}
  .pill.ok{background:var(--ok)}
  .card{background:var(--card);border-radius:14px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:18px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 6}
  .col-4{grid-column:span 4}
  .col-3{grid-column:span 3}
  .header{border-bottom:2px solid #eaeaea;padding-bottom:16px;margin-bottom:16px}
  .buttons{display:flex;gap:8px;flex-wrap:wrap}
  button.btn{padding:8px 14px;border:2px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer;font-weight:700}
  button.btn.active{background:var(--primary);color:#fff}
  .metric{display:flex;flex-direction:column;gap:6px}
  .metric .title{font-size:13px;color:var(--muted);font-weight:700}
  .metric .value{font-size:32px;font-weight:800}
  .metric .delta{display:inline-block;font-weight:700;padding:4px 10px;border-radius:999px}
  .delta.up{color:var(--ok);background:rgba(39,174,96,.12)}
  .delta.down{color:var(--primary);background:rgba(231,76,60,.12)}
  .label{color:var(--muted);font-size:13px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  input[type="date"]{padding:8px 10px;border:2px solid var(--primary);border-radius:8px;font-weight:700}
  a.link{color:#3498db;text-decoration:none}
  a.link:hover{text-decoration:underline}
  .loading{display:none;align-items:center;gap:8px}
  .loading.show{display:inline-flex}
  .spinner{width:12px;height:12px;border:2px solid #fff;border-top:2px solid transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:900px){.col-6{grid-column:span 12}.col-4{grid-column:span 12}.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>🚢 ✈️ MJL 아시아발 글로벌 물류 운임 대시보드</h1>
      <div class="subtitle">MJ LOGISTICS GLOBAL FREIGHT RATE DASHBOARD</div>
      <div class="bar">
        <span id="lastUpdate" class="pill muted">마지막 업데이트: -</span>
        <span class="pill">아시아(중국/베트남) → 북미/유럽/인도</span>
        <span id="syncPill" class="pill ok">연결 중…</span>
        <span id="debugPill" class="pill muted small">디버그: 대기</span>
      </div>
    </div>

    <!-- 데이터 안내 -->
    <div class="card col-12" style="margin-bottom:16px">
      <div class="label">📊 실시간 데이터 연동</div>
      <div class="small muted" style="margin-top:4px">
        Google Sheets(Apps Script JSONP)로 자동 업데이트 됩니다. 시트 수정은
        <a id="sheetLink" class="link" target="_blank" rel="noopener">스프레드시트 열기</a>
      </div>
    </div>

    <!-- 컨트롤 -->
    <div class="card" style="margin-bottom:16px">
      <div class="row">
        <div class="col-6">
          <div class="buttons" id="rangeBtns">
            <button class="btn" data-range="2W">2주</button>
            <button class="btn" data-range="1M">1개월</button>
            <button class="btn" data-range="3M">3개월</button>
            <button class="btn" data-range="6M">6개월</button>
            <button class="btn active" data-range="1Y">1년</button>
            <button class="btn" data-range="2Y">2년</button>
            <button class="btn" data-range="MAX">전체</button>
          </div>
        </div>
        <div class="col-6" style="display:flex;justify-content:flex-end;gap:10px;align-items:center">
          <span class="label">운임 현황 기준일:</span>
          <input id="datePicker" type="date" />
          <span id="hintNear" class="small muted">가장 가까운 주간 데이터로 반영됩니다.</span>
        </div>
      </div>
    </div>

    <!-- 4 지표 -->
    <div class="row" id="kpiRow" style="margin-bottom:16px">
      <div class="col-4">
        <div class="card metric">
          <div class="title">발틱운임지수 (BDI)</div>
          <div id="bdiVal" class="value">-</div>
          <div id="bdiDelta" class="delta">-</div>
        </div>
      </div>
      <div class="col-4">
        <div class="card metric">
          <div class="title">상해컨테이너운임지수 (SCFI)</div>
          <div id="scfiVal" class="value">-</div>
          <div id="scfiDelta" class="delta">-</div>
        </div>
      </div>
      <div class="col-4">
        <div class="card metric">
          <div class="title">중국컨테이너운임지수 (CCFI)</div>
          <div id="ccfiVal" class="value">-</div>
          <div id="ccfiDelta" class="delta">-</div>
        </div>
      </div>
      <div class="col-4">
        <div class="card metric">
          <div class="title">HRCI 지수</div>
          <div id="hrciVal" class="value">-</div>
          <div id="hrciDelta" class="delta">-</div>
        </div>
      </div>
    </div>

    <!-- 테이블(해상/항공) : 컬럼이 충분치 않으면 자동으로 숨김 -->
    <div class="row">
      <div class="col-6">
        <div class="card">
          <div class="label" style="margin-bottom:8px">🚢 최신 해상 운임 (USD/TEU)</div>
          <div id="seaTableWrap" class="small muted">시트에 해상 목적지 열이 준비되면 자동 표시됩니다.</div>
        </div>
      </div>
      <div class="col-6">
        <div class="card">
          <div class="label" style="margin-bottom:8px">✈️ 최신 항공 운임 (USD/kg)</div>
          <div id="airTableWrap" class="small muted">시트에 항공 목적지 열이 준비되면 자동 표시됩니다.</div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===================== 설정 ===================== */
/** 1) 여기에 "현재" Apps Script 웹앱 URL(…/exec)을 붙여 넣으세요. */
const WEB_APP_URL = 'PASTE_YOUR_EXEC_URL_HERE'; // ← ← ← 여기 바꾸기!

/** 2) 시트 보기 링크(선택). */
const SHEET_URL   = 'https://docs.google.com/spreadsheets/d/1FST2PUn1-2cxLiv6igJ_ssCKAC9gaqvVv22j83UApts/edit';

/** 3) 새로고침 주기(분). */
const REFRESH_INTERVAL_MIN = 5;

/* =============== 내부 상태 =============== */
let rawRows = [];          // [ [헤더…], [데이터…], … ]
let header  = [];          // 헤더 1행
let dateCol = 0;           // 날짜 열 인덱스
let idxMap  = {};          // { BDI:1, SCFI:2, … }  (존재할 때만)
let lastDateIdx = -1;
let currentRange = '1Y';

/* =============== 유틸 =============== */
const $ = sel => document.querySelector(sel);
const el = id => document.getElementById(id);
function fmt(n, d=2){ return (isFinite(n)? Number(n).toFixed(d): '-'); }
function pct(a,b){
  if(!isFinite(a)||!isFinite(b)||b===0) return null;
  return ((a-b)/b*100);
}
function nearestIndexByDate(isoDate){
  if(!rawRows.length) return -1;
  const target = new Date(isoDate).getTime();
  let best = -1, bestDiff = 1e18;
  for(let i=1;i<rawRows.length;i++){
    const t = new Date(rawRows[i][dateCol]).getTime();
    const diff = Math.abs(t-target);
    if(diff < bestDiff){ bestDiff = diff; best = i; }
  }
  return best;
}
function monthsBackIndex(months){
  if(lastDateIdx<0) return 1;
  // 데이터가 주간 기준이므로 대략 4주 = 1달 가정
  const back = Math.round(months*4);
  return Math.max(1, lastDateIdx - back);
}

/* =============== UI =============== */
function setSync(text, ok=true){
  const pill = el('syncPill');
  pill.textContent = text;
  pill.className = 'pill ' + (ok ? 'ok' : 'muted');
}
function setDebug(text){ el('debugPill').textContent = '디버그: ' + text; }

function buildMiniTable(wrapperId, colsWanted){
  const wrap = el(wrapperId);
  // 준비된 목적지 열만 추출
  const exists = colsWanted.filter(c => header.includes(c));
  if(exists.length === 0){
    wrap.innerHTML = '<div class="small muted">관련 열이 아직 없습니다.</div>';
    return;
  }
  const idxs = exists.map(n => header.indexOf(n));
  const i = lastDateIdx;
  const rows = exists.map((name, k) => {
    const v = parseFloat(rawRows[i][idxs[k]])||0;
    return `<div class="row" style="align-items:center;margin-bottom:6px">
              <div class="col-6 small">${name.replaceAll('_',' ')}</div>
              <div class="col-6" style="text-align:right;font-weight:800">$${fmt(v, name.includes('kg')?2:0)}</div>
            </div>`;
  }).join('');
  wrap.innerHTML = rows;
}

/* 4 KPI 업데이트 (있을 때만) */
function updateKPIs(){
  if(lastDateIdx<1) return;
  const startIdx =
    currentRange==='2W'? Math.max(1,lastDateIdx-2):
    currentRange==='1M'? Math.max(1,lastDateIdx-4):
    currentRange==='3M'? Math.max(1,lastDateIdx-13):
    currentRange==='6M'? Math.max(1,lastDateIdx-26):
    currentRange==='1Y'? Math.max(1,lastDateIdx-52):
    currentRange==='2Y'? Math.max(1,lastDateIdx-104): 1;

  const sets = [
    {k:'BDI',  val:'bdiVal',  d:'bdiDelta',  digits:0},
    {k:'SCFI', val:'scfiVal', d:'scfiDelta', digits:2},
    {k:'CCFI', val:'ccfiVal', d:'ccfiDelta', digits:2},
    {k:'HRCI', val:'hrciVal', d:'hrciDelta', digits:1},
  ];
  sets.forEach(s=>{
    const cIdx = idxMap[s.k];
    const vEl  = el(s.val), dEl = el(s.d);
    if(cIdx==null){ vEl.textContent='-'; dEl.textContent='-'; dEl.className='delta'; return; }
    const curr = parseFloat(rawRows[lastDateIdx][cIdx])||0;
    const prev = parseFloat(rawRows[startIdx][cIdx])||0;
    vEl.textContent = isFinite(curr)? fmt(curr, s.digits): '-';
    const p = pct(curr,prev);
    if(p==null){ dEl.textContent='-'; dEl.className='delta'; }
    else{
      const up = p>=0;
      dEl.textContent = (up?'▲ ':'▼ ') + Math.abs(p).toFixed(1)+'%';
      dEl.className = 'delta ' + (up?'up':'down');
    }
  });

  // 기준일
  const d = new Date(rawRows[lastDateIdx][dateCol]);
  el('lastUpdate').textContent = `마지막 업데이트: ${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* =============== 데이터 파싱 =============== */
function parseData(arr){
  rawRows = Array.isArray(arr)? arr.slice(): [];
  if(rawRows.length<2){ throw new Error('데이터 부족'); }
  header = rawRows[0];

  // 날짜 열 탐지: '날짜' 혹은 Date로 파싱 가능한 첫 열
  dateCol = 0;
  const dateIdxByName = header.findIndex(h => (h+'').includes('날짜'));
  if(dateIdxByName>=0) dateCol = dateIdxByName;

  // 지표 인덱스(있을 때만 등록)
  idxMap = {};
  ['BDI','SCFI','CCFI','HRCI'].forEach(name=>{
    const i = header.findIndex(h => (h+'').trim().toUpperCase().includes(name));
    if(i>=0) idxMap[name]=i;
  });

  // 마지막 행(최신일)
  lastDateIdx = rawRows.length-1;

  // datePicker: min/max 지정
  const minD = new Date(rawRows[1][dateCol]);
  const maxD = new Date(rawRows[lastDateIdx][dateCol]);
  const dp = el('datePicker');
  dp.min = minD.toISOString().slice(0,10);
  dp.max = maxD.toISOString().slice(0,10);
  dp.value = maxD.toISOString().slice(0,10);
}

/* =============== 렌더링 =============== */
function renderAll(){
  updateKPIs();

  // 해상/항공 미니 테이블(열이 있을 때만)
  buildMiniTable('seaTableWrap', [
    // 시트 헤더 명을 그대로 사용 (예: 상해_해상_LA, 상해_해상_로테르담 …)
    '상해_해상_LA', '상해_해상_롱비치', '상해_해상_로테르담',
    '홍콩_해상_LA',  '홍콩_해상_롱비치',  '홍콩_해상_로테르담',
    '심천_해상_LA',  '심천_해상_롱비치',  '심천_해상_로테르담',
  ]);
  buildMiniTable('airTableWrap', [
    // 예시(필요 시 시트 헤더명에 맞춰 추가/수정)
    '상해_항공_LAX', '상해_항공_JFK', '상해_항공_VIE',
    '홍콩_항공_LAX', '홍콩_항공_JFK', '홍콩_항공_VIE',
  ]);
}

/* =============== JSONP 로드 =============== */
function loadFromAppsScript(){
  setSync('연결 중…', true); setDebug('요청 준비');
  // 이전 스크립트 제거
  const old = document.getElementById('jsonp-script');
  if(old) old.remove();

  // JSONP 콜백
  window.handleGoogleSheetsData = function(resp){
    try{
      if(!resp || resp.status!=='success' || !Array.isArray(resp.data)){
        throw new Error('응답 형식 오류');
      }
      setDebug('응답 수신');
      parseData(resp.data);
      renderAll();
      setSync('동기화 완료', true);
    }catch(e){
      console.error(e);
      setSync('데이터 오류', false);
      setDebug('파싱 실패');
    }
  };

  // JSONP 스크립트 삽입
  const s = document.createElement('script');
  s.id = 'jsonp-script';
  s.src = WEB_APP_URL + '?callback=handleGoogleSheetsData&_=' + Date.now();
  s.onerror = function(){
    setSync('연결 실패', false);
    setDebug('JSONP 로드 실패');
  };
  document.body.appendChild(s);
}

/* =============== 이벤트 =============== */
function onRangeClick(e){
  const btn = e.target.closest('button');
  if(!btn) return;
  document.querySelectorAll('#rangeBtns .btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentRange = btn.dataset.range;
  renderAll();
}
function onDatePicked(e){
  const v = e.target.value;
  const i = nearestIndexByDate(v);
  if(i>0){ lastDateIdx = i; renderAll(); }
}

/* =============== 시작 =============== */
document.addEventListener('DOMContentLoaded', ()=>{
  // 링크/컨트롤
  el('sheetLink').href = SHEET_URL;
  $('#rangeBtns').addEventListener('click', onRangeClick);
  el('datePicker').addEventListener('change', onDatePicked);

  // 첫 로드 & 주기적 새로고침
  loadFromAppsScript();
  setInterval(loadFromAppsScript, REFRESH_INTERVAL_MIN*60*1000);
});
</script>
</body>
</html>
